{% extends "base.html" %}

{% block title %}Reporte {{ month_name }} {{ year }} - Registro de Ingresos{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <!-- Header mejorado -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">üìä {{ month_name }} {{ year }}</h2>
                <p class="text-gray-600 mt-1">{{ days_in_month }} d√≠as ¬∑ Total: $<span id="total-mes-display">{% set
                        total_month = 0 %}{% for day in range(1, days_in_month + 1) %}{% set day_transactions =
                        transactions_by_day.get(day, []) %}{% set day_total = day_transactions | sum(attribute='amount')
                        if day_transactions else 0 %}{% set total_month = total_month + day_total %}{% endfor %}{{
                        "%.2f"|format(total_month) }}</span></p>
            </div>
            <div class="flex space-x-3"> <a href="{{ url_for('print_report', year=year, month=month) }}?auto=true"
                    target="_blank"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center text-sm">
                    <span class="mr-1">üñ®Ô∏è</span>
                    Imprimir
                </a>
                <button onclick="calculateTotal()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center text-sm">
                    <span class="mr-1">üßÆ</span>
                    Recalcular
                </button>
            </div>
        </div>

        <!-- Grid de d√≠as optimizado -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3">
            {% for day in range(1, days_in_month + 1) %}
            {% set day_transactions = transactions_by_day.get(day, []) %}
            {% set day_total = day_transactions | sum(attribute='amount') if day_transactions else 0 %}

            <div
                class="bg-gradient-to-br from-gray-50 to-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-all h-80 flex flex-col">
                <!-- Header del d√≠a -->
                <div class="p-3 border-b border-gray-200 bg-white rounded-t-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <div
                                class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">
                                {{ day }}
                            </div>
                            <span class="text-sm font-medium text-gray-700">
                                {% set day_names = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado',
                                'Domingo'] %}
                                {% set date_obj = day + (year|int - 1970) * 365 + ((year|int - 1969) / 4)|int -
                                ((year|int - 1901) / 100)|int + ((year|int - 1601) / 400)|int %}
                                {% set weekday = (date_obj + 3) % 7 %}
                                {{ day_names[weekday|int] }}
                            </span>
                        </div>
                        <div class="text-right">
                            {% if day_total > 0 %}
                            <span class="text-green-600 font-bold text-sm">${{ "%.2f"|format(day_total) }}</span>
                            <p class="text-xs text-gray-500">{{ day_transactions|length }} item{{ 's' if
                                day_transactions|length != 1 else '' }}</p>
                            {% else %}
                            <span class="text-gray-400 text-xs">$0.00</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Lista de transacciones con scroll -->
                <div class="flex-1 overflow-y-auto p-2">
                    {% if day_transactions %}
                    <div class="space-y-1" id="transactions-{{ day }}">
                        {% for transaction in day_transactions %}
                        <div class="bg-white rounded border border-gray-100 p-2 group hover:border-blue-200 transition-colors"
                            data-id="{{ transaction.id }}">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0 mr-1">
                                    <p class="text-xs font-semibold text-green-600">${{
                                        "%.2f"|format(transaction.amount) }}</p>
                                    {% if transaction.description %}
                                    <p class="text-xs text-gray-600 truncate" title="{{ transaction.description }}">{{
                                        transaction.description }}</p>
                                    {% else %}
                                    <p class="text-xs text-gray-400 italic">Sin descripci√≥n</p>
                                    {% endif %}
                                </div>
                                <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button
                                        onclick="editTransaction({{ transaction.id }}, {{ transaction.amount }}, '{{ (transaction.description or '')|replace("'", "\\'") }}')"
                                        class="text-blue-500 hover:text-blue-700 text-xs p-1" title="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="deleteTransaction({{ transaction.id }})"
                                        class="text-red-500 hover:text-red-700 text-xs p-1" title="Eliminar">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div> {% else %}
                    <div class="flex items-center justify-center h-full text-gray-400">
                        <div class="text-center select-none no-copy-income" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; 
                                    -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; 
                                    pointer-events: none; cursor: default;" oncontextmenu="return false;"
                            onselectstart="return false;" ondragstart="return false;">
                            <div class="text-2xl mb-1">üí∞</div>
                            <p class="text-xs">Sin ingresos</p>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Formulario compacto -->
                <div class="p-2 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                    <form onsubmit="addTransaction(event, {{ day }})" class="space-y-1">
                        <div class="flex gap-1">
                            <input type="number" step="0.01" placeholder="$"
                                class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                required>
                            <button type="submit"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-medium transition-colors">
                                +
                            </button>
                        </div>
                        <input type="text" placeholder="Descripci√≥n..." maxlength="30"
                            class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal para editar -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Editar Transacci√≥n</h3>
        <div class="space-y-3">
            <input type="number" id="editAmount" step="0.01" placeholder="Monto"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="text" id="editDescription" placeholder="Descripci√≥n" maxlength="30"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="flex space-x-2 mt-4">
            <button onclick="saveEdit()"
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition-colors text-sm">
                Guardar
            </button> <button onclick="closeModal()"
                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 rounded-lg font-medium transition-colors text-sm">
                Cancelar
            </button>
        </div>
    </div>
</div>

<!-- Modal de confirmaci√≥n personalizado -->
<div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 shadow-2xl">
        <div class="text-center">
            <div class="text-4xl mb-4">‚ö†Ô∏è</div>
            <h3 id="confirmTitle" class="text-lg font-bold text-gray-900 mb-2">Confirmar acci√≥n</h3>
            <p id="confirmMessage" class="text-gray-600 mb-6"></p>
        </div>
        <div class="flex space-x-3">
            <button onclick="closeConfirmModal()"
                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg font-medium transition-colors">
                Cancelar
            </button>
            <button id="confirmButton" onclick="confirmAction()"
                class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-medium transition-colors">
                Eliminar
            </button>
        </div>
    </div>
</div>

<!-- Modal de alerta personalizado -->
<div id="alertModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 shadow-2xl">
        <div class="text-center">
            <div id="alertIcon" class="text-4xl mb-4">‚ÑπÔ∏è</div>
            <h3 id="alertTitle" class="text-lg font-bold text-gray-900 mb-2">Informaci√≥n</h3>
            <p id="alertMessage" class="text-gray-600 mb-6"></p>
        </div>
        <div class="flex justify-center">
            <button onclick="closeAlertModal()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                Entendido
            </button>
        </div>
    </div>
</div>

<script>
    let currentEditId = null;
    let hasRecentChanges = false;
    let autoRecalcTimer = null;
    let lastTransactionCount = 0;
    const YEAR = {{ year }};
    const MONTH = {{ month }}; function addTransaction(event, day) {
        event.preventDefault();
        const form = event.target;
        const amount = form.querySelector('input[type="number"]').value;
        const description = form.querySelector('input[type="text"]').value; if (!amount || parseFloat(amount) <= 0) {
            showCustomAlert('Por favor ingresa un monto v√°lido', 'error');
            return;
        }

        // DETECCI√ìN: Verificar si este d√≠a estaba vac√≠o antes de agregar
        const dayWasEmpty = !document.getElementById(`transactions-${day}`);

        const data = {
            year: YEAR,
            month: MONTH,
            day: day,
            amount: parseFloat(amount),
            description: description
        }; fetch('/add-transaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => response.json()).then(responseData => {
                if (responseData.success) {
                    // Limpiar el formulario
                    form.reset(); if (dayWasEmpty) {
                        // PRIMERA TRANSACCI√ìN DEL D√çA: Intento de actualizaci√≥n sin recarga
                        showNotification('‚úÖ Agregado exitosamente', 'success');

                        try {
                            // Intentar actualizaci√≥n manual completa
                            addTransactionToDOM(day, responseData.transaction);
                            updateDayTotal(day);
                            updateMonthTotal();

                            // Actualizar visualmente el header del d√≠a para mostrar el nuevo total
                            const dayCard = document.querySelectorAll('.grid > div')[day - 1];
                            if (dayCard) {
                                const headerSection = dayCard.querySelector('.text-right');
                                if (headerSection) {
                                    const totalElement = headerSection.querySelector('.text-gray-400');
                                    if (totalElement) {
                                        totalElement.textContent = `$${parseFloat(responseData.transaction.amount).toFixed(2)}`;
                                        totalElement.className = 'text-green-600 font-bold text-sm';

                                        // Agregar indicador de items
                                        const existingCount = headerSection.querySelector('.text-xs.text-gray-500');
                                        if (!existingCount) {
                                            const countElement = document.createElement('p');
                                            countElement.className = 'text-xs text-gray-500';
                                            countElement.textContent = '1 item';
                                            headerSection.appendChild(countElement);
                                        }
                                    }
                                }
                            }

                            markRecentChange();

                            // Solo recarga si algo espec√≠fico falla
                            setTimeout(() => {
                                // Verificar si la transacci√≥n se agreg√≥ correctamente
                                const addedTransaction = document.querySelector(`[data-id="${responseData.transaction.id}"]`);
                                if (!addedTransaction) {
                                    console.log('Transacci√≥n no encontrada en DOM, recargando...');
                                    window.location.reload();
                                }
                            }, 200);

                        } catch (error) {
                            console.error('Error en actualizaci√≥n manual:', error);
                            // Solo recargar si hay error real
                            setTimeout(() => {
                                window.location.reload();
                            }, 300);
                        }
                    } else {
                        // TRANSACCIONES ADICIONALES: Actualizaci√≥n AJAX
                        addTransactionToDOM(day, responseData.transaction);
                        updateDayTotal(day);
                        updateMonthTotal();
                        markRecentChange();
                        showNotification('Transacci√≥n agregada exitosamente', 'success');
                    }
                } else {
                    showCustomAlert('Error: ' + responseData.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showCustomAlert('Error al agregar la transacci√≥n', 'error');
            });
    } function deleteTransaction(id) {
        const settings = JSON.parse(localStorage.getItem('appSettings') || '{"confirmDelete": true}');

        if (settings.confirmDelete) {
            showConfirmDialog(
                '¬øEliminar esta transacci√≥n?',
                'Esta acci√≥n no se puede deshacer.',
                function () {
                    executeDeleteTransaction(id);
                }
            );
        } else {
            executeDeleteTransaction(id);
        }
    } function executeDeleteTransaction(id) {
        fetch(`/delete-transaction/${id}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remover el elemento del DOM en lugar de recargar
                    const transactionElement = document.querySelector(`[data-id="${id}"]`);
                    if (transactionElement) {
                        transactionElement.remove();

                        // Actualizar totales
                        updateAllTotals();

                        markRecentChange();
                        showNotification('Transacci√≥n eliminada exitosamente', 'success');
                    }
                } else {
                    showCustomAlert('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showCustomAlert('Error al eliminar la transacci√≥n', 'error');
            });
    }

    function editTransaction(id, amount, description) {
        currentEditId = id;
        document.getElementById('editAmount').value = amount;
        document.getElementById('editDescription').value = description || '';
        document.getElementById('editModal').classList.remove('hidden');
    } function saveEdit() {
        const amount = document.getElementById('editAmount').value;
        const description = document.getElementById('editDescription').value; if (!amount || parseFloat(amount) <= 0) {
            showCustomAlert('Por favor ingresa un monto v√°lido', 'error');
            return;
        }

        const data = {
            amount: parseFloat(amount),
            description: description
        }; fetch(`/edit-transaction/${currentEditId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();

                    // Actualizar la transacci√≥n en el DOM
                    const transactionElement = document.querySelector(`[data-id="${currentEditId}"]`);
                    if (transactionElement) {
                        const amountElement = transactionElement.querySelector('.text-green-600');
                        const descElement = transactionElement.querySelector('.text-gray-600, .text-gray-400');

                        if (amountElement) amountElement.textContent = `$${parseFloat(data.amount || amount).toFixed(2)}`;
                        if (descElement) {
                            descElement.textContent = description || 'Sin descripci√≥n';
                            descElement.className = description ? 'text-xs text-gray-600 truncate' : 'text-xs text-gray-400 italic';
                        }

                        // Actualizar totales
                        updateAllTotals();
                    }

                    markRecentChange();
                    showNotification('Transacci√≥n editada exitosamente', 'success');
                } else {
                    showCustomAlert('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showCustomAlert('Error al editar la transacci√≥n', 'error');
            });
    }

    function closeModal() {
        document.getElementById('editModal').classList.add('hidden');
        currentEditId = null;
    }    // Cerrar modal con Escape
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') closeModal();
    });    // Funci√≥n para agregar transacci√≥n al DOM din√°micamente
    function addTransactionToDOM(day, transaction) {
        // Buscar el contenedor del d√≠a de manera m√°s robusta
        const dayCards = document.querySelectorAll('.grid > div');
        let dayContainer = null;

        // Encontrar el contenedor del d√≠a correcto
        dayCards.forEach((card, index) => {
            if (index + 1 === day) {
                dayContainer = card.querySelector('.flex-1.overflow-y-auto.p-2');
            }
        });

        if (!dayContainer) {
            console.error(`No se encontr√≥ el contenedor para el d√≠a ${day}`);
            // En lugar de forzar recarga inmediata, intentar de nuevo despu√©s de un breve delay
            setTimeout(() => {
                window.location.reload();
            }, 300);
            return;
        }

        // Verificar si existe el contenedor de transacciones
        let transactionsContainer = dayContainer.querySelector(`#transactions-${day}`);

        if (!transactionsContainer) {
            // El d√≠a estaba vac√≠o - remover mensaje "Sin ingresos" con animaci√≥n suave
            const emptyMessage = dayContainer.querySelector('.text-center');
            if (emptyMessage) {
                emptyMessage.style.opacity = '0';
                emptyMessage.style.transform = 'scale(0.8)';
                emptyMessage.style.transition = 'all 0.3s ease';

                setTimeout(() => {
                    emptyMessage.remove();
                }, 300);
            }

            // Crear nuevo contenedor de transacciones con animaci√≥n
            transactionsContainer = document.createElement('div');
            transactionsContainer.className = 'space-y-1';
            transactionsContainer.id = `transactions-${day}`;
            transactionsContainer.style.opacity = '0';
            transactionsContainer.style.transform = 'translateY(10px)';
            dayContainer.appendChild(transactionsContainer);

            // Animar entrada del contenedor
            setTimeout(() => {
                transactionsContainer.style.transition = 'all 0.3s ease';
                transactionsContainer.style.opacity = '1';
                transactionsContainer.style.transform = 'translateY(0)';
            }, 100);
        }

        // Crear el elemento de la nueva transacci√≥n
        const transactionElement = document.createElement('div');
        transactionElement.className = 'bg-white rounded border border-gray-100 p-2 group hover:border-blue-200 transition-colors';
        transactionElement.setAttribute('data-id', transaction.id);

        transactionElement.innerHTML = `
            <div class="flex items-start justify-between">
                <div class="flex-1 min-w-0 mr-1">
                    <p class="text-xs font-semibold text-green-600">$${parseFloat(transaction.amount).toFixed(2)}</p>
                    <p class="text-xs ${transaction.description ? 'text-gray-600 truncate' : 'text-gray-400 italic'}" ${transaction.description ? `title="${transaction.description}"` : ''}>
                        ${transaction.description || 'Sin descripci√≥n'}
                    </p>
                </div>
                <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editTransaction(${transaction.id}, ${transaction.amount}, '${(transaction.description || '').replace(/'/g, "\\'")}')" 
                            class="text-blue-500 hover:text-blue-700 text-xs p-1" title="Editar">
                        ‚úèÔ∏è
                    </button>
                    <button onclick="deleteTransaction(${transaction.id})" 
                            class="text-red-500 hover:text-red-700 text-xs p-1" title="Eliminar">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        `;

        // Agregar con animaci√≥n suave
        transactionElement.style.opacity = '0';
        transactionElement.style.transform = 'translateY(-10px)';

        const container = document.getElementById(`transactions-${day}`);
        container.appendChild(transactionElement);

        // Animar entrada
        setTimeout(() => {
            transactionElement.style.transition = 'all 0.3s ease';
            transactionElement.style.opacity = '1';
            transactionElement.style.transform = 'translateY(0)';
        }, 50);
    }

    // Funci√≥n para actualizar el total de un d√≠a espec√≠fico
    function updateDayTotal(day) {
        const dayHeader = document.querySelector(`[data-day="${day}"] .text-right, .grid > div:nth-child(${day}) .text-right`);
        if (!dayHeader) return;

        const transactions = document.querySelectorAll(`#transactions-${day} [data-id]`);
        let total = 0;

        transactions.forEach(transaction => {
            const amountText = transaction.querySelector('.text-green-600').textContent;
            const amount = parseFloat(amountText.replace('$', ''));
            total += amount;
        });

        // Actualizar el display del total del d√≠a
        const totalSpan = dayHeader.querySelector('.text-green-600, .text-gray-400');
        const countP = dayHeader.querySelector('.text-xs.text-gray-500');

        if (total > 0) {
            if (totalSpan) {
                totalSpan.textContent = `$${total.toFixed(2)}`;
                totalSpan.className = 'text-green-600 font-bold text-sm';
            }
            if (countP) {
                const count = transactions.length;
                countP.textContent = `${count} item${count !== 1 ? 's' : ''}`;
            }
        } else {
            if (totalSpan) {
                totalSpan.textContent = '$0.00';
                totalSpan.className = 'text-gray-400 text-xs';
            }
            if (countP) {
                countP.textContent = '';
            }
        }
    }

    // Funci√≥n para actualizar el total del mes
    function updateMonthTotal() {
        let total = 0;
        document.querySelectorAll('[data-id]').forEach(transaction => {
            const amountText = transaction.querySelector('.text-green-600').textContent;
            const amount = parseFloat(amountText.replace('$', ''));
            total += amount;
        });

        const totalDisplay = document.getElementById('total-mes-display');
        if (totalDisplay) {
            totalDisplay.textContent = total.toFixed(2);
        }
    }

    // Funci√≥n para actualizar todos los totales
    function updateAllTotals() {
        // Actualizar totales por d√≠a
        for (let day = 1; day <= 31; day++) {
            const dayTransactions = document.getElementById(`transactions-${day}`);
            if (dayTransactions) {
                updateDayTotal(day);
            }
        }

        // Actualizar total del mes
        updateMonthTotal();
    }

    // Funci√≥n para recalcular el total
    function calculateTotal() {
        // Recalcular y actualizar el total mostrado
        let total = 0;
        document.querySelectorAll('[data-id]').forEach(transaction => {
            const amountText = transaction.querySelector('.text-green-600').textContent;
            const amount = parseFloat(amountText.replace('$', ''));
            total += amount;
        });

        const totalDisplay = document.getElementById('total-mes-display');
        if (totalDisplay) {
            totalDisplay.textContent = total.toFixed(2);
        }

        // Mostrar notificaci√≥n
        showNotification('Total recalculado: $' + total.toFixed(2), 'success');
    }

    // Sistema de notificaciones
    function showNotification(message, type = 'info') {
        const existing = document.getElementById('notification');
        if (existing) existing.remove();

        const notification = document.createElement('div');
        notification.id = 'notification';
        notification.className = `fixed top-20 right-4 z-50 p-3 rounded-lg shadow-lg transition-all duration-300 ${type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;

        notification.innerHTML = `
            <div class="flex items-center">
                <span class="mr-2">${type === 'success' ? '‚úÖ' :
                type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'
            }</span>
                <span class="text-sm">${message}</span>
            </div>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }
        }, 3000);
    }

    // ========== SISTEMA INTELIGENTE DE REC√ÅLCULO AUTOM√ÅTICO ==========

    // Marcar que hubo cambios recientes
    function markRecentChange() {
        hasRecentChanges = true;

        // Limpiar timer anterior si existe
        if (autoRecalcTimer) {
            clearTimeout(autoRecalcTimer);
        }

        // Configurar nuevo timer para rec√°lculo en 30 segundos
        autoRecalcTimer = setTimeout(() => {
            if (hasRecentChanges) {
                autoRecalculate();
                hasRecentChanges = false;
            }
        }, 30000); // 30 segundos

        showNotification('‚è±Ô∏è Rec√°lculo autom√°tico programado en 30s', 'info');
    }

    // Rec√°lculo autom√°tico inteligente
    function autoRecalculate() {
        const currentTransactionCount = document.querySelectorAll('[data-id]').length;

        // Solo recalcular si hay cambios reales
        if (currentTransactionCount !== lastTransactionCount || hasRecentChanges) {
            calculateTotalSilent(); // Versi√≥n silenciosa para auto-rec√°lculo
            lastTransactionCount = currentTransactionCount;
            showNotification('üîÑ Total actualizado autom√°ticamente', 'success');
        }
    }

    // Detectar cambios en el DOM
    function detectChanges() {
        const currentTransactionCount = document.querySelectorAll('[data-id]').length;

        if (currentTransactionCount !== lastTransactionCount) {
            markRecentChange();
            lastTransactionCount = currentTransactionCount;
        }
    }

    // Versi√≥n silenciosa del rec√°lculo (sin notificaci√≥n)
    function calculateTotalSilent() {
        let total = 0;
        document.querySelectorAll('[data-id]').forEach(transaction => {
            const amountText = transaction.querySelector('.text-green-600').textContent;
            const amount = parseFloat(amountText.replace('$', ''));
            total += amount;
        });

        const totalDisplay = document.getElementById('total-mes-display');
        if (totalDisplay) {
            totalDisplay.textContent = total.toFixed(2);
        }
    }

    // Rec√°lculo manual (cancela el autom√°tico)
    function calculateTotal() {
        // Limpiar timer autom√°tico ya que se est√° haciendo manualmente
        if (autoRecalcTimer) {
            clearTimeout(autoRecalcTimer);
            autoRecalcTimer = null;
            hasRecentChanges = false;
        }

        calculateTotalSilent();
        showNotification('üí∞ Total recalculado manualmente', 'success');
    }

    // Inicializaci√≥n inteligente
    document.addEventListener('DOMContentLoaded', function () {
        lastTransactionCount = document.querySelectorAll('[data-id]').length;

        // Verificar cambios cada 10 segundos (frecuente para detectar cambios r√°pido)
        setInterval(detectChanges, 10000);

        // Mostrar informaci√≥n inicial
        showNotification(`üìä Sistema de rec√°lculo activo - ${lastTransactionCount} transacciones`, 'info');

        // Configurar observer para cambios en el DOM (m√°s avanzado)
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'childList' &&
                    (mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0)) {
                    detectChanges();
                }
            });
        });        // Observar cambios en las areas de transacciones
        const container = document.querySelector('.grid');
        if (container) {
            observer.observe(container, {
                childList: true,
                subtree: true
            });
        }

        // ========== PROTECCI√ìN CONTRA COPIA ==========

        // Prevenir copia del texto protegido
        document.addEventListener('keydown', function (e) {
            // Prevenir Ctrl+A, Ctrl+C, Ctrl+V en elementos no copiables
            if ((e.ctrlKey || e.metaKey) && (e.key === 'a' || e.key === 'c' || e.key === 'v')) {
                const target = e.target.closest('.no-copy') || e.target.closest('.no-copy-income');
                if (target) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }
        });

        // Prevenir selecci√≥n con doble clic
        document.addEventListener('selectstart', function (e) {
            if (e.target.closest('.no-copy') || e.target.closest('.no-copy-income')) {
                e.preventDefault();
                return false;
            }
        });

        // Prevenir men√∫ contextual
        document.addEventListener('contextmenu', function (e) {
            if (e.target.closest('.no-copy') || e.target.closest('.no-copy-income')) {
                e.preventDefault();
                return false;
            }
        });
    });

    // ========== SISTEMA DE MODALES PERSONALIZADOS ==========

    // Variables globales para modales
    let confirmCallback = null;

    // Mostrar modal de confirmaci√≥n
    function showConfirmDialog(title, message, callback) {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmModal').classList.remove('hidden');
        confirmCallback = callback;
    }

    // Confirmar acci√≥n
    function confirmAction() {
        if (confirmCallback) {
            confirmCallback();
            confirmCallback = null;
        }
        closeConfirmModal();
    }

    // Cerrar modal de confirmaci√≥n
    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.add('hidden');
        confirmCallback = null;
    }

    // Mostrar alerta personalizada
    function showCustomAlert(message, type = 'info') {
        const alertModal = document.getElementById('alertModal');
        const alertIcon = document.getElementById('alertIcon');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');

        // Configurar contenido seg√∫n el tipo
        if (type === 'error') {
            alertIcon.textContent = '‚ùå';
            alertTitle.textContent = 'Error';
            alertTitle.className = 'text-lg font-bold text-red-600 mb-2';
        } else if (type === 'success') {
            alertIcon.textContent = '‚úÖ';
            alertTitle.textContent = '√âxito';
            alertTitle.className = 'text-lg font-bold text-green-600 mb-2';
        } else {
            alertIcon.textContent = '‚ÑπÔ∏è';
            alertTitle.textContent = 'Informaci√≥n';
            alertTitle.className = 'text-lg font-bold text-blue-600 mb-2';
        }

        alertMessage.textContent = message;
        alertModal.classList.remove('hidden');
    }

    // Cerrar modal de alerta
    function closeAlertModal() {
        document.getElementById('alertModal').classList.add('hidden');
    }
</script>
{% endblock %}