{% extends "base.html" %}

{% block title %}Reporte {{ year }}/{{ month }} - Sistema Seguro{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header del reporte -->
    <div
        class="bg-gradient-to-r from-green-50 to-emerald-100 rounded-lg shadow-lg p-8 border-l-4 border-green-500 mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    📊 Reporte Mensual
                </h1>
                <p class="text-gray-600">
                    Período: {{ month }}/{{ year }}
                </p>
            </div>
            <div class="text-6xl opacity-50">
                📈
            </div>
        </div>
    </div>

    <!-- Navegación -->
    <div class="mb-6">
        <a href="{{ url_for('nuevo_reporte') }}"
            class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
            <span class="mr-2">←</span>
            Volver a Nuevo Reporte
        </a>
    </div>

    <!-- Contenido del reporte -->
    <div class="bg-white rounded-lg shadow-md p-8 border border-gray-200">
        <div class="text-center py-12">
            <div class="text-6xl mb-4">🚧</div>
            <h2 class="text-2xl font-semibold text-gray-900 mb-4">
                Reporte en Construcción
            </h2>
            <p class="text-gray-600 mb-6">
                El sistema de reportes está siendo desarrollado.<br>
                Los datos para {{ month }}/{{ year }} estarán disponibles próximamente.
            </p>

            <!-- Información del período seleccionado -->
            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200 max-w-md mx-auto">
                <h3 class="text-lg font-semibold text-blue-800 mb-2">Período Seleccionado:</h3>
                <div class="text-blue-700">
                    <div class="mb-2">
                        <strong>Año:</strong> {{ year }}
                    </div>
                    <div class="mb-2">
                        <strong>Mes:</strong> {{ month }}
                    </div>
                    <div class="text-sm text-blue-600">
                        Reporte generado el {{ moment().format('DD/MM/YYYY HH:mm') }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Funciones futuras -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
            <div class="text-3xl mb-3">💰</div>
            <h3 class="font-semibold text-gray-900 mb-2">Ingresos</h3>
            <p class="text-sm text-gray-600">Resumen de ingresos del período</p>
        </div>

        <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
            <div class="text-3xl mb-3">📈</div>
            <h3 class="font-semibold text-gray-900 mb-2">Análisis</h3>
            <p class="text-sm text-gray-600">Gráficos y tendencias</p>
        </div>

        <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
            <div class="text-3xl mb-3">📄</div>
            <h3 class="font-semibold text-gray-900 mb-2">Exportar</h3>
            <p class="text-sm text-gray-600">PDF, Excel, CSV</p>
        </div>
    </div>
</div>

<script>
    // Placeholder para funcionalidad futura del reporte
    console.log('Reporte para {{ year }}/{{ month }} cargado');

    // Simular fecha actual (ya que no tenemos moment.js)
    document.addEventListener('DOMContentLoaded', function () {
        const now = new Date();
        const dateStr = now.toLocaleDateString('es-ES') + ' ' + now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

        // Si hay elementos con moment(), reemplazarlos
        const momentElements = document.querySelectorAll('[data-moment]');
        momentElements.forEach(el => {
            el.textContent = dateStr;
        });

        // Sistema de actualización automática para formularios
        setupAutoRefresh();
    });    // Función para actualizar contenido sin recargar página
    async function refreshContent() {
        try {
            console.log('🔄 Iniciando actualización de contenido...');

            const response = await fetch(window.location.href);
            if (response.ok) {
                const html = await response.text();
                const parser = new DOMParser();
                const newDocument = parser.parseFromHTML(html, 'text/html');

                // Detectar si era un día sin cards ANTES de actualizar
                const wasEmpty = checkIfFirstTransaction();
                console.log('📊 Contenido estaba vacío antes:', wasEmpty);

                // Verificar si el nuevo contenido tiene nuevas cards de días
                const newDayCards = newDocument.querySelectorAll('.bg-white.rounded-2xl, .bg-white.rounded-xl, .border.border-gray-200');
                const newCardsWithData = Array.from(newDayCards).filter(card => {
                    return card.textContent.includes('$') || card.textContent.includes('ingreso') || card.textContent.includes('transacción');
                });

                console.log('📊 Nuevas cards de días:', newDayCards.length);
                console.log('📊 Nuevas cards con datos:', newCardsWithData.length);

                // Si estaba vacío PERO ahora hay nuevas cards con datos, necesitamos recarga completa
                if (wasEmpty && newCardsWithData.length > 0) {
                    console.log('🔄 DETECCIÓN CRÍTICA: Nueva card de día creada - Forzando recarga');
                    window.location.reload();
                    return;
                }

                // Detección adicional: verificar cards actuales vs nuevas
                const currentDayCards = document.querySelectorAll('.bg-white.rounded-2xl, .bg-white.rounded-xl, .border.border-gray-200');
                const currentCardsWithData = Array.from(currentDayCards).filter(card => {
                    return card.textContent.includes('$') || card.textContent.includes('ingreso');
                });

                console.log('📊 Cards actuales:', currentDayCards.length);
                console.log('📊 Cards actuales con datos:', currentCardsWithData.length);

                // Si hay diferencia significativa en número de cards, recargar
                if (newCardsWithData.length > currentCardsWithData.length) {
                    console.log('🔄 Nueva card de día detectada - Recarga completa necesaria');
                    window.location.reload();
                    return;
                }

                // Actualizar contenido principal completo para cambios normales
                const currentMain = document.querySelector('.space-y-8, .max-w-4xl, main, [class*="container"]');
                const newMain = newDocument.querySelector('.space-y-8, .max-w-4xl, main, [class*="container"]');

                if (currentMain && newMain) {
                    console.log('⚡ Actualizando contenido vía AJAX');
                    // Guardar el scroll actual
                    const scrollPosition = window.scrollY;

                    // Actualizar todo el contenido principal
                    currentMain.innerHTML = newMain.innerHTML;

                    // Restaurar el scroll
                    window.scrollTo(0, scrollPosition);

                    // Re-configurar eventos después de actualizar el DOM
                    setTimeout(setupAutoRefresh, 100);
                } else {
                    console.log('⚠️ No se pudo encontrar contenido principal - Fallback');
                    // Fallback: actualizar partes específicas
                    updateSpecificSections(newDocument);
                }

                // Actualizar gráficos si existen
                if (typeof updateCharts === 'function') {
                    updateCharts();
                }
            }
        } catch (error) {
            console.log('❌ Error al actualizar contenido:', error);
            // En caso de error, recargar la página
            console.log('🔄 Error detectado - Fallback a recarga completa');
            window.location.reload();
        }
    }    // Función de respaldo para actualizar secciones específicas
    function updateSpecificSections(newDocument) {
        console.log('🔄 Ejecutando actualización específica de secciones...');

        // Actualizar cards de días específicas
        const currentDayCards = document.querySelectorAll('.bg-white.rounded-2xl, .bg-white.rounded-xl, .border.border-gray-200');
        const newDayCards = newDocument.querySelectorAll('.bg-white.rounded-2xl, .bg-white.rounded-xl, .border.border-gray-200');

        console.log('🔄 Cards actuales:', currentDayCards.length, 'Cards nuevas:', newDayCards.length);

        // Si hay diferencia en número de cards, recargar página completa
        if (newDayCards.length > currentDayCards.length) {
            console.log('🔄 Detectadas nuevas cards de días - Recargando página');
            window.location.reload();
            return;
        }

        // Actualizar contenido de cards existentes
        currentDayCards.forEach((currentCard, index) => {
            if (newDayCards[index]) {
                const currentContent = currentCard.innerHTML;
                const newContent = newDayCards[index].innerHTML;

                if (currentContent !== newContent) {
                    console.log('🔄 Actualizando card de día', index);
                    currentCard.innerHTML = newContent;
                }
            }
        });

        // Actualizar tabla de transacciones si existe
        const currentTable = document.querySelector('table tbody');
        const newTable = newDocument.querySelector('table tbody');
        if (currentTable && newTable) {
            console.log('🔄 Actualizando tabla de transacciones');
            currentTable.innerHTML = newTable.innerHTML;
        }

        // Actualizar totales y estadísticas
        const currentStats = document.querySelectorAll('.text-green-600, .text-blue-600, .text-purple-600, .font-bold.text-2xl, .font-bold.text-3xl');
        const newStats = newDocument.querySelectorAll('.text-green-600, .text-blue-600, .text-purple-600, .font-bold.text-2xl, .font-bold.text-3xl');
        currentStats.forEach((stat, index) => {
            if (newStats[index] && stat.classList.toString() === newStats[index].classList.toString()) {
                if (stat.textContent !== newStats[index].textContent) {
                    console.log('🔄 Actualizando estadística', index);
                    stat.textContent = newStats[index].textContent;
                }
            }
        });

        // Verificar si se necesita agregar contenido completamente nuevo
        const currentContainer = document.querySelector('[class*="grid"], [class*="space-y"]');
        const newContainer = newDocument.querySelector('[class*="grid"], [class*="space-y"]');

        if (currentContainer && newContainer) {
            const currentChildren = currentContainer.children.length;
            const newChildren = newContainer.children.length;

            console.log('🔄 Contenedor actual:', currentChildren, 'Contenedor nuevo:', newChildren);

            // Si hay contenido nuevo, reemplazar completamente
            if (newChildren > currentChildren) {
                console.log('🔄 Detectado contenido completamente nuevo - Reemplazando contenedor');
                currentContainer.innerHTML = newContainer.innerHTML;
            }
        }
    }

    // Configurar sistema de auto-refresh
    function setupAutoRefresh() {
        const forms = document.querySelectorAll('form');

        forms.forEach(form => {
            form.addEventListener('submit', async function (e) {
                // Verificar si es un formulario de transacción o edición
                if (this.action && (this.action.includes('/add') || this.action.includes('/update') || this.action.includes('/save') || this.action.includes('/edit'))) {
                    e.preventDefault();

                    const formData = new FormData(this);
                    const submitButton = this.querySelector('button[type="submit"]');
                    const originalText = submitButton ? submitButton.innerHTML : '';

                    // Mostrar estado de carga
                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Guardando...</span>';
                    }
                    try {
                        const response = await fetch(this.action, {
                            method: this.method || 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            showNotification('✅ Transacción guardada exitosamente', 'success');

                            // Limpiar formulario si es de agregar
                            if (this.action.includes('/add')) {
                                this.reset();
                            }
                            // NUEVA LÓGICA MEJORADA: Detectar si es primera transacción del día
                            const isFirstTransaction = checkIfFirstTransaction();

                            console.log('📋 Resultado detección primera transacción:', isFirstTransaction);
                            if (isFirstTransaction) {
                                console.log('🔄 Primera transacción del día confirmada - Forzando recarga');
                                showNotification('🔄 Primera transacción agregada - Actualizando vista...', 'info');

                                // Dar más tiempo para que se procese la transacción en el servidor
                                setTimeout(() => {
                                    console.log('🔄 Ejecutando recarga...');
                                    window.location.reload();
                                }, 1500);

                                // Restaurar botón inmediatamente (no esperar la recarga)
                                if (submitButton) {
                                    setTimeout(() => {
                                        submitButton.disabled = false;
                                        submitButton.innerHTML = originalText;
                                    }, 800);
                                }
                            } else {
                                console.log('⚡ Transacción subsecuente - Actualización AJAX');
                                // Actualizar contenido inmediatamente para transacciones subsecuentes
                                setTimeout(async () => {
                                    await refreshContent();

                                    // Restaurar botón
                                    if (submitButton) {
                                        submitButton.disabled = false;
                                        submitButton.innerHTML = originalText;
                                    }
                                }, 300);
                            }

                            // VERIFICACIÓN ADICIONAL: Programar verificación post-envío
                            schedulePostSubmitVerification();

                        } else {
                            throw new Error('Error en el servidor');
                        }
                    } catch (error) {
                        showNotification('❌ Error al guardar la transacción', 'error');

                        // Restaurar botón en caso de error
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = originalText;
                        }
                    }
                }
            });
        });
    }

    // Sistema de notificaciones
    function showNotification(message, type = 'info') {
        // Remover notificación existente
        const existing = document.getElementById('notification');
        if (existing) existing.remove();

        // Crear nueva notificación
        const notification = document.createElement('div');
        notification.id = 'notification';
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-0 ${type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                    'bg-blue-500 text-white'
            }`;

        notification.innerHTML = `
            <div class="flex items-center">
                <span class="text-sm font-medium">${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        `;

        document.body.appendChild(notification);

        // Auto-remover después de 4 segundos
        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 4000);
    }    // Función para detectar si es la primera transacción del día/período
    function checkIfFirstTransaction() {
        console.log('🔍 Verificando si es primera transacción del día específico...');

        // 1. Verificar si hay cards/boxes de días con datos
        const dayCards = document.querySelectorAll('.bg-white.rounded-2xl, .bg-white.rounded-xl, .day-card, [class*="day-"], .border.border-gray-200, .shadow-lg');
        const dayCardsWithData = Array.from(dayCards).filter(card => {
            const cardText = card.textContent.toLowerCase();
            return cardText.includes('$') || cardText.includes('ingreso') || cardText.includes('transacción');
        });

        console.log('📊 Cards de días encontradas:', dayCards.length);
        console.log('📊 Cards con datos:', dayCardsWithData.length);

        // Si no hay cards de días con datos, definitivamente es primera transacción
        if (dayCardsWithData.length === 0) {
            console.log('✅ Primera transacción detectada: No hay cards de días con datos');
            return true;
        }

        // 2. Verificar si hay muy pocas cards (menos de 2-3 días con datos)
        if (dayCardsWithData.length <= 1) {
            console.log('✅ Primera transacción detectada: Muy pocas cards con datos');
            return true;
        }

        // 3. Buscar indicadores específicos de días vacíos
        const emptyDayIndicators = [
            'sin transacciones para este día',
            'día vacío',
            'no hay registros',
            'sin ingresos registrados',
            'agregar primera transacción',
            'comienza registrando'
        ];

        const bodyText = document.body.textContent.toLowerCase();
        for (const indicator of emptyDayIndicators) {
            if (bodyText.includes(indicator.toLowerCase())) {
                console.log('✅ Primera transacción detectada: Indicador de día vacío encontrado:', indicator);
                return true;
            }
        }

        // 4. Verificar si existe algún formulario activo para un día sin datos previos
        const forms = document.querySelectorAll('form[action*="add"]');
        for (const form of forms) {
            const parentCard = form.closest('.bg-white, .rounded-2xl, .rounded-xl, .border');
            if (parentCard) {
                const hasExistingData = parentCard.querySelector('table tbody tr, .transaction-item, [class*="monto"], [class*="amount"]');
                if (!hasExistingData) {
                    console.log('✅ Primera transacción detectada: Formulario en card sin datos previos');
                    return true;
                }
            }
        }

        // 5. Verificar estructura del DOM - si hay menos de 3 elementos significativos por día
        const significantElements = document.querySelectorAll('.bg-white.rounded-2xl, .bg-white.rounded-xl, .border.border-gray-200');
        const elementsWithTransactions = Array.from(significantElements).filter(el => {
            return el.textContent.includes('$') || el.textContent.includes('total') || el.textContent.includes('ingreso');
        });

        console.log('📊 Elementos significativos:', significantElements.length);
        console.log('📊 Elementos con transacciones:', elementsWithTransactions.length);

        if (elementsWithTransactions.length <= 2) {
            console.log('✅ Primera transacción detectada: Pocos elementos con transacciones');
            return true;
        }

        console.log('❌ No es primera transacción - hay contenido de días previo');
        return false;
    }    // Sistema de verificación post-envío
    function schedulePostSubmitVerification() {
        setTimeout(() => {
            console.log('🔍 Verificación post-envío ejecutándose...');

            // Verificar específicamente si aparecieron nuevas cards de días
            const dayCards = document.querySelectorAll('.bg-white.rounded-2xl, .bg-white.rounded-xl, .border.border-gray-200');
            const cardsWithData = Array.from(dayCards).filter(card => {
                return card.textContent.includes('$') || card.textContent.includes('ingreso') || card.textContent.includes('transacción');
            });

            console.log('🔍 Verificación: Cards encontradas:', dayCards.length);
            console.log('🔍 Verificación: Cards con datos:', cardsWithData.length);

            const stillEmpty = checkIfFirstTransaction();
            if (stillEmpty || cardsWithData.length === 0) {
                console.log('⚠️ ALERTA: La transacción del día no apareció en su card');
                console.log('🔄 Forzando recarga de seguridad...');
                showNotification('🔄 Sincronizando datos del día...', 'info');
                window.location.reload();
            } else {
                console.log('✅ Verificación exitosa: La card del día está visible con datos');
            }
        }, 3000);
    }
</script>
{% endblock %}