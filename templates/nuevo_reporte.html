{% extends "base.html" %}

{% block title %}Nuevo Reporte - Registro de Ingresos{% endblock %}

{% block content %}
<div class="max-w-lg mx-auto">
    <div class="bg-gradient-to-r from-blue-50 to-indigo-100 rounded-lg shadow-lg p-8 border-l-4 border-blue-500">
        <div class="text-center mb-6">
            <div class="text-blue-600 text-4xl mb-4">üìä</div>
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Nuevo Reporte Mensual</h2>
            <p class="text-gray-600">Selecciona el per√≠odo para crear tu reporte</p>
        </div>

        <form id="reporteForm" class="space-y-4">
            <div>
                <label for="year" class="block text-sm font-medium text-gray-700 mb-2">A√±o</label>
                <div class="custom-wheel-picker" data-input="year">
                    <input type="hidden" id="year" name="year" value="{{ current_year or 2024 }}">
                    <div class="wheel-container">
                        <div class="wheel-overlay-top"></div>
                        <div class="wheel-selector"></div>
                        <div class="wheel-overlay-bottom"></div>
                        <div class="wheel-content" id="yearWheel">
                            {% for year in range(2020, 2040) %}
                            <div class="wheel-item" data-value="{{ year }}">{{ year }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label for="month" class="block text-sm font-medium text-gray-700 mb-2">Mes</label>
                <div class="custom-wheel-picker" data-input="month">
                    <input type="hidden" id="month" name="month" value="{{ current_month or 1 }}">
                    <div class="wheel-container">
                        <div class="wheel-overlay-top"></div>
                        <div class="wheel-selector"></div>
                        <div class="wheel-overlay-bottom"></div>
                        <div class="wheel-content" id="monthWheel">
                            <div class="wheel-item" data-value="1">Enero</div>
                            <div class="wheel-item" data-value="2">Febrero</div>
                            <div class="wheel-item" data-value="3">Marzo</div>
                            <div class="wheel-item" data-value="4">Abril</div>
                            <div class="wheel-item" data-value="5">Mayo</div>
                            <div class="wheel-item" data-value="6">Junio</div>
                            <div class="wheel-item" data-value="7">Julio</div>
                            <div class="wheel-item" data-value="8">Agosto</div>
                            <div class="wheel-item" data-value="9">Septiembre</div>
                            <div class="wheel-item" data-value="10">Octubre</div>
                            <div class="wheel-item" data-value="11">Noviembre</div>
                            <div class="wheel-item" data-value="12">Diciembre</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bot√≥n de test para debugging -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <button type="button" id="debugBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-lg">
                    üîç Debug: Ver Valores Actuales
                </button>
                <div id="debugInfo" class="mt-2 text-sm text-gray-600 hidden">
                    <p><strong>A√±o:</strong> <span id="debugYear"></span></p>
                    <p><strong>Mes:</strong> <span id="debugMonth"></span></p>
                    <p><strong>URL que se generar√≠a:</strong> <span id="debugUrl"></span></p>
                </div>
            </div>

            <button type="submit"
                class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-all transform hover:scale-105 shadow-lg">
                <span class="mr-2">üìà</span>
                Crear Reporte
            </button>
        </form>

        <div class="mt-6 text-center">
            <p class="text-sm text-gray-500 select-none no-copy" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; 
                      -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; 
                      pointer-events: none; cursor: default;" oncontextmenu="return false;"
                onselectstart="return false;" ondragstart="return false;">
                üí° Tip: Puedes crear reportes para cualquier mes del a√±o
            </p>
        </div>
    </div>
</div>

<style>
    /* Estilos para Wheel Picker estilo iPhone */
    .custom-wheel-picker {
        position: relative;
        width: 100%;
        height: 120px;
        margin: 8px 0;
    }

    .wheel-container {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 16px;
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        border: 2px solid #e2e8f0;
        overflow: hidden;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.08);
        perspective: 800px;
    }

    .wheel-content {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: auto;
        transform-style: preserve-3d;
        transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        cursor: grab;
    }

    .wheel-content:active {
        cursor: grabbing;
    }

    .wheel-item {
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 500;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.3s ease;
        transform-origin: center;
        backface-visibility: hidden;
        user-select: none;
    }

    .wheel-item:hover {
        color: #3b82f6;
        transform: scale(1.04);
    }

    .wheel-item.selected {
        color: #1f2937;
        font-weight: 700;
        transform: scale(1.08);
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .wheel-overlay-top,
    .wheel-overlay-bottom {
        position: absolute;
        left: 0;
        width: 100%;
        height: 40px;
        pointer-events: none;
        z-index: 10;
    }

    .wheel-overlay-top {
        top: 0;
        background: linear-gradient(to bottom,
                rgba(248, 250, 252, 0.95) 0%,
                rgba(248, 250, 252, 0.8) 50%,
                rgba(248, 250, 252, 0) 100%);
    }

    .wheel-overlay-bottom {
        bottom: 0;
        background: linear-gradient(to top,
                rgba(248, 250, 252, 0.95) 0%,
                rgba(248, 250, 252, 0.8) 50%,
                rgba(248, 250, 252, 0) 100%);
    }

    .wheel-selector {
        position: absolute;
        top: 40px;
        left: 12%;
        width: 76%;
        height: 40px;
        border: 2px solid #3b82f6;
        border-radius: 12px;
        background: rgba(59, 130, 246, 0.08);
        pointer-events: none;
        z-index: 5;
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.25);
    }

    /* Responsive */
    @media (max-width: 640px) {
        .wheel-item {
            font-size: 14px;
            height: 36px;
        }

        .custom-wheel-picker {
            height: 110px;
        }

        .wheel-selector {
            top: 37px;
            height: 36px;
        }

        .wheel-overlay-top,
        .wheel-overlay-bottom {
            height: 37px;
        }
    }
</style>

<script>
    // Sistema de Wheel Picker estilo iPhone
    class WheelPicker {
        constructor(container, inputId) {
            this.container = container;
            this.inputId = inputId;
            this.wheelContent = container.querySelector('.wheel-content');
            this.items = container.querySelectorAll('.wheel-item');
            this.currentIndex = -1; // No inicializar en 0, esperar a setValue
            this.isDragging = false;
            this.startY = 0;
            this.currentY = 0;
            this.velocity = 0;
            this.lastY = 0;
            this.lastTime = 0;

            this.itemHeight = window.innerWidth <= 640 ? 36 : 40;
            this.maxTranslate = -(this.items.length - 1) * this.itemHeight;

            this.init();
        }

        init() {
            // Event listeners
            this.wheelContent.addEventListener('mousedown', this.onStart.bind(this));
            this.wheelContent.addEventListener('touchstart', this.onStart.bind(this));

            document.addEventListener('mousemove', this.onMove.bind(this));
            document.addEventListener('touchmove', this.onMove.bind(this));

            document.addEventListener('mouseup', this.onEnd.bind(this));
            document.addEventListener('touchend', this.onEnd.bind(this));

            // Click en items
            this.items.forEach((item, index) => {
                item.addEventListener('click', () => {
                    this.snapToIndex(index);
                });
            });

            // Scroll con mouse
            this.wheelContent.addEventListener('wheel', this.onWheel.bind(this));
        }

        onStart(e) {
            this.isDragging = true;
            this.startY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
            this.currentY = this.startY;
            this.lastY = this.startY;
            this.lastTime = Date.now();
            this.velocity = 0;
        }

        onMove(e) {
            if (!this.isDragging) return;
            e.preventDefault();

            this.currentY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;
            const deltaY = this.currentY - this.startY;
            const translateY = Math.max(this.maxTranslate, Math.min(0, deltaY));
            
            this.wheelContent.style.transform = `translateY(${translateY}px)`;
        }

        onEnd(e) {
            if (!this.isDragging) return;
            this.isDragging = false;

            const deltaY = this.currentY - this.startY;
            const velocity = deltaY / (Date.now() - this.lastTime);
            
            // Calcular el √≠ndice basado en la posici√≥n final
            const currentTranslate = this.getCurrentTranslate();
            const targetIndex = Math.round(-currentTranslate / this.itemHeight);
            const clampedIndex = Math.max(0, Math.min(this.items.length - 1, targetIndex));
            
            this.snapToIndex(clampedIndex);
        }

        onWheel(e) {
            e.preventDefault();
            const direction = e.deltaY > 0 ? 1 : -1;
            const newIndex = Math.max(0, Math.min(this.currentIndex + direction, this.items.length - 1));
            this.snapToIndex(newIndex);
        }

        snapToIndex(index) {
            this.currentIndex = index;
            this.updatePosition();
            this.updateSelection();
        }

        updatePosition() {
            if (this.currentIndex === -1) {
                // No se ha establecido un valor inicial, no actualizar posici√≥n
                return;
            }
            const translateY = -this.currentIndex * this.itemHeight;
            this.wheelContent.style.transform = `translateY(${translateY}px)`;
        }

        updateSelection() {
            if (this.currentIndex === -1) {
                // No se ha establecido un valor inicial, no actualizar selecci√≥n
                return;
            }
            // Actualizar clases
            this.items.forEach((item, index) => {
                item.classList.toggle('selected', index === this.currentIndex);
            });

            // Actualizar input hidden
            const selectedValue = this.items[this.currentIndex].dataset.value;
            document.getElementById(this.inputId).value = selectedValue;
        }

        getCurrentTranslate() {
            const style = window.getComputedStyle(this.wheelContent);
            const matrix = new DOMMatrix(style.transform);
            return matrix.m42;
        }

        // M√©todo p√∫blico para establecer valor
        setValue(value) {
            console.log(`setValue called with: ${value}, type: ${typeof value}`);
            const index = Array.from(this.items).findIndex(item => {
                const itemValue = item.dataset.value;
                console.log(`Comparing ${itemValue} with ${value}, match: ${itemValue === value.toString()}`);
                return itemValue === value.toString();
            });
            
            console.log(`Found index: ${index} for value: ${value}`);
            
            if (index !== -1) {
                this.currentIndex = index;
                this.updatePosition();
                this.updateSelection();
                console.log(`Successfully set value to index ${index}, currentIndex: ${this.currentIndex}`);
            } else {
                console.error(`Value ${value} not found in items`);
            }
        }

        // M√©todo p√∫blico para obtener el valor actual
        getValue() {
            return this.items[this.currentIndex].dataset.value;
        }

        // M√©todo para sincronizar la posici√≥n visual con el valor actual
        syncVisualPosition() {
            // Asegurar que la posici√≥n visual coincida con el √≠ndice actual
            this.updatePosition();
            this.updateSelection();
        }

        // M√©todo para forzar sincronizaci√≥n completa
        forceSync() {
            if (this.currentIndex !== -1) {
                // Forzar actualizaci√≥n de posici√≥n y selecci√≥n
                this.updatePosition();
                this.updateSelection();
                
                // Verificar que el input hidden tenga el valor correcto
                const expectedValue = this.items[this.currentIndex].dataset.value;
                const inputElement = document.getElementById(this.inputId);
                if (inputElement && inputElement.value !== expectedValue) {
                    inputElement.value = expectedValue;
                    console.log(`Forced sync: Updated ${this.inputId} from ${inputElement.value} to ${expectedValue}`);
                }
            }
        }
    }

    // Inicializar wheel pickers
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM loaded, initializing wheel pickers...');
        
        const yearPicker = new WheelPicker(
            document.querySelector('[data-input="year"]'),
            'year'
        );

        const monthPicker = new WheelPicker(
            document.querySelector('[data-input="month"]'),
            'month'
        );

        // Establecer valores por defecto al a√±o/mes actual
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1;

        console.log(`Current date: ${currentDate}`);
        console.log(`Current year: ${currentYear}, Current month: ${currentMonth}`);

        // IMPORTANTE: Establecer los valores despu√©s de que los pickers est√©n inicializados
        setTimeout(() => {
            console.log('Setting initial values - Year:', currentYear, 'Month:', currentMonth);
            
            // Verificar valores antes de setValue
            console.log('Year input value before setValue:', document.getElementById('year').value);
            console.log('Month input value before setValue:', document.getElementById('month').value);
            
            // ARREGLAR EL OFFSET: Ajustar el √≠ndice para que coincida con la posici√≥n visual
            yearPicker.setValue(currentYear);
            monthPicker.setValue(currentMonth);
            
            // Sincronizar la posici√≥n visual despu√©s de establecer los valores
            yearPicker.syncVisualPosition();
            monthPicker.syncVisualPosition();
            
            // Forzar sincronizaci√≥n completa para asegurar que no haya offset
            yearPicker.forceSync();
            monthPicker.forceSync();
            
            // Verificar que los valores se establecieron correctamente
            console.log('Year input value after setValue:', document.getElementById('year').value);
            console.log('Month input value after setValue:', document.getElementById('month').value);
            console.log('Year picker current index:', yearPicker.currentIndex);
            console.log('Month picker current index:', monthPicker.currentIndex);
            
            // Test adicional: verificar que los valores coinciden
            const yearInputValue = document.getElementById('year').value;
            const monthInputValue = document.getElementById('month').value;
            const yearPickerValue = yearPicker.getValue();
            const monthPickerValue = monthPicker.getValue();
            
            console.log('=== VALIDATION TEST ===');
            console.log('Year input vs picker:', yearInputValue, '===', yearPickerValue, 'Match:', yearInputValue === yearPickerValue);
            console.log('Month input vs picker:', monthInputValue, '===', monthPickerValue, 'Match:', monthInputValue === monthPickerValue);
            
            if (yearInputValue !== yearPickerValue || monthInputValue !== monthPickerValue) {
                console.error('‚ùå MISMATCH DETECTED! Values are not synchronized!');
            } else {
                console.log('‚úÖ All values are properly synchronized!');
            }
        }, 100);

        // Form submission
        document.getElementById('reporteForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value;
            
            // Debug: mostrar los valores seleccionados
            console.log('=== FORM SUBMISSION DEBUG ===');
            console.log('Selected year:', year, 'Selected month:', month);
            console.log('Year type:', typeof year, 'Month type:', typeof month);
            console.log('Year picker current index:', yearPicker.currentIndex);
            console.log('Month picker current index:', monthPicker.currentIndex);
            console.log('Year picker getValue():', yearPicker.getValue());
            console.log('Month picker getValue():', monthPicker.getValue());
            console.log('Year input value:', document.getElementById('year').value);
            console.log('Month input value:', document.getElementById('month').value);
            
            // Validar que los valores sean v√°lidos
            if (!year || !month) {
                alert('Por favor selecciona un a√±o y mes v√°lidos');
                return;
            }
            
            // Verificar que los valores sean n√∫meros v√°lidos
            if (isNaN(parseInt(year)) || isNaN(parseInt(month))) {
                alert('Los valores de a√±o y mes deben ser n√∫meros v√°lidos');
                return;
            }
            
            const url = `/report/${year}/${month}`;
            console.log('Redirecting to:', url);
            
            window.location.href = url;
        });

        // Bot√≥n de debug
        document.getElementById('debugBtn').addEventListener('click', function() {
            const year = document.getElementById('year').value;
            const month = document.getElementById('month').value;
            const url = `/report/${year}/${month}`;
            
            document.getElementById('debugYear').textContent = year;
            document.getElementById('debugMonth').textContent = month;
            document.getElementById('debugUrl').textContent = url;
            
            document.getElementById('debugInfo').classList.remove('hidden');
            
            console.log('=== DEBUG BUTTON CLICKED ===');
            console.log('Year input value:', year);
            console.log('Month input value:', month);
            console.log('Generated URL:', url);
            console.log('Year picker current index:', yearPicker.currentIndex);
            console.log('Month picker current index:', monthPicker.currentIndex);
            console.log('Year picker getValue():', yearPicker.getValue());
            console.log('Month picker getValue():', monthPicker.getValue());
        });
    });

    // Prevenir copia del texto protegido
    document.addEventListener('keydown', function (e) {
        if ((e.ctrlKey || e.metaKey) && (e.key === 'a' || e.key === 'c' || e.key === 'v')) {
            const target = e.target.closest('.no-copy');
            if (target) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }
    });

    document.addEventListener('selectstart', function (e) {
        if (e.target.closest('.no-copy')) {
            e.preventDefault();
            return false;
        }
    });

    document.addEventListener('contextmenu', function (e) {
        if (e.target.closest('.no-copy')) {
            e.preventDefault();
            return false;
        }
    });
</script>
{% endblock %}