{% extends "base.html" %}

{% block title %}Reportes - Registro de Ingresos{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header mejorado -->
    <div
        class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 rounded-2xl shadow-xl p-8 text-white relative overflow-hidden">
        <div class="absolute inset-0 bg-white opacity-10 transform skew-y-1"></div>
        <div class="relative z-10 flex items-center justify-between">
            <div>
                <h2 class="text-3xl font-bold mb-2">üìä Todos los Reportes</h2>
                <p class="text-blue-100 text-lg">Historial completo de tus reportes mensuales con an√°lisis detallado</p>
            </div>
            <div class="text-right">
                <div class="bg-white bg-opacity-20 rounded-xl p-4 backdrop-filter backdrop-blur-sm">
                    <p class="text-sm font-medium text-blue-100">Total Reportes</p>
                    <p class="text-3xl font-bold text-white">
                        {% if reports %}
                        {% if reports.total is defined %}{{ reports.total }}{% else %}{{ reports|length }}{% endif %}
                        {% else %}0{% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen estad√≠stico -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div
            class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-blue-500 hover:shadow-xl transition-all duration-300">
            <div class="text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-blue-600 text-2xl">üìä</span>
                </div>
                <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Total Reportes</p>
                <p class="text-3xl font-bold text-blue-600 mt-2">
                    {% if reports %}
                    {% if reports.total is defined %}{{ reports.total }}{% else %}{{ reports|length }}{% endif %}
                    {% else %}0{% endif %}
                </p>
            </div>
        </div>

        <div
            class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-green-500 hover:shadow-xl transition-all duration-300">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-green-600 text-2xl">üèÜ</span>
                </div>
                <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Mejor Mes</p>
                {% if reports %}
                {% set report_list = reports.items if reports.items is defined else reports %}
                {% if report_list and report_list|length > 0 %}
                {% set mejor_mes = report_list|max(attribute='total') %}
                <p class="text-xl font-bold text-green-600 mt-2">{{ mejor_mes.month_name }} {{ mejor_mes.year }}</p>
                <p class="text-sm text-green-500">${{ "%.2f"|format(mejor_mes.total) }}</p>
                {% else %}
                <p class="text-xl text-gray-400 mt-2">Sin datos</p>
                {% endif %}
                {% else %}
                <p class="text-xl text-gray-400 mt-2">Sin datos</p>
                {% endif %}
            </div>
        </div>

        <div
            class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-purple-500 hover:shadow-xl transition-all duration-300">
            <div class="text-center">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-purple-600 text-2xl">üìà</span>
                </div>
                <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Promedio Mensual</p>
                {% if reports %}
                {% set report_list = reports.items if reports.items is defined else reports %}
                {% if report_list and report_list|length > 0 %}
                {% set total_sum = report_list|sum(attribute='total') %}
                <p class="text-3xl font-bold text-purple-600 mt-2">${{ "%.2f"|format(total_sum / report_list|length) }}
                </p>
                {% else %}
                <p class="text-3xl text-gray-400 mt-2">$0.00</p>
                {% endif %}
                {% else %}
                <p class="text-3xl text-gray-400 mt-2">$0.00</p>
                {% endif %}
            </div>
        </div>
    </div>

    {% if reports %}
    {% set report_list = reports.items if reports.items is defined else reports %}
    {% if report_list and report_list|length > 0 %}
    <!-- Tabla de reportes mejorada -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="bg-gray-50 px-8 py-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-900 flex items-center">
                    <span class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center mr-3">üìã</span>
                    Reportes Mensuales
                </h3>
                <div class="text-sm text-gray-600">
                    {% if reports.items is defined %}
                    Mostrando {{ report_list|length }} de {{ reports.total }} reportes
                    {% else %}
                    Mostrando {{ report_list|length }} reportes
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-8 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Per√≠odo</th>
                        <th class="px-8 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Total Ingresos</th>
                        <th class="px-8 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Transacciones</th>
                        <th class="px-8 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Promedio Diario</th>
                        <th class="px-8 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for report in report_list %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-8 py-6 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-blue-600 text-sm font-bold">{{ report.month }}</span>
                                </div>
                                <div>
                                    <div class="text-sm font-semibold text-gray-900">{{ report.month_name }} {{
                                        report.year }}</div>
                                    <div class="text-xs text-gray-500">{{ report.dias_registrados }} d√≠as activos</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-8 py-6 whitespace-nowrap">
                            <div class="text-lg font-bold text-green-600">${{ "%.2f"|format(report.total) }}</div>
                        </td>
                        <td class="px-8 py-6 whitespace-nowrap">
                            <span
                                class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                {{ report.total_transactions }} transacciones
                            </span>
                        </td>
                        <td class="px-8 py-6 whitespace-nowrap">
                            <div class="text-sm font-semibold text-gray-900">${{ "%.2f"|format(report.total /
                                report.dias_registrados if report.dias_registrados > 0 else 0) }}</div>
                            <div class="text-xs text-gray-500">por d√≠a activo</div>
                        </td>
                        <td class="px-8 py-6 whitespace-nowrap">
                            <div class="flex space-x-3">
                                <a href="{{ url_for('monthly_report', year=report.year, month=report.month) }}"
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center">
                                    <span class="mr-1">‚úèÔ∏è</span>
                                    Ver/Editar
                                </a>
                                <a href="{{ url_for('print_report', year=report.year, month=report.month) }}"
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center">
                                    <span class="mr-1">üñ®Ô∏è</span>
                                    Imprimir
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Paginaci√≥n -->
        {% if reports.pages is defined and reports.pages > 1 %}
        <div class="bg-gray-50 px-8 py-6 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center text-sm text-gray-700">
                    <span>Mostrando p√°gina {{ reports.page }} de {{ reports.pages }}</span>
                    <span class="mx-2">‚Ä¢</span>
                    <span>{{ reports.total }} reportes totales</span>
                </div>

                <div class="flex items-center space-x-2">
                    <!-- Bot√≥n anterior -->
                    {% if reports.has_prev %}
                    <a href="{{ url_for('view_reports', page=reports.prev_num) }}"
                        class="bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium transition-colors flex items-center">
                        <span class="mr-1">‚Üê</span>
                        Anterior
                    </a>
                    {% else %}
                    <span
                        class="bg-gray-100 text-gray-400 px-4 py-2 rounded-lg border border-gray-200 text-sm font-medium cursor-not-allowed flex items-center">
                        <span class="mr-1">‚Üê</span>
                        Anterior
                    </span>
                    {% endif %}

                    <!-- N√∫meros de p√°gina -->
                    <div class="flex items-center space-x-1">
                        {% for page_num in reports.iter_pages() %}
                        {% if page_num %}
                        {% if page_num != reports.page %}
                        <a href="{{ url_for('view_reports', page=page_num) }}"
                            class="w-10 h-10 bg-white hover:bg-gray-50 text-gray-700 rounded-lg border border-gray-300 text-sm font-medium transition-colors flex items-center justify-center">
                            {{ page_num }}
                        </a>
                        {% else %}
                        <span
                            class="w-10 h-10 bg-blue-600 text-white rounded-lg text-sm font-medium flex items-center justify-center">
                            {{ page_num }}
                        </span>
                        {% endif %}
                        {% else %}
                        <span class="w-10 h-10 text-gray-400 text-sm flex items-center justify-center">
                            ...
                        </span>
                        {% endif %}
                        {% endfor %}
                    </div>

                    <!-- Bot√≥n siguiente -->
                    {% if reports.has_next %}
                    <a href="{{ url_for('view_reports', page=reports.next_num) }}"
                        class="bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium transition-colors flex items-center">
                        Siguiente
                        <span class="ml-1">‚Üí</span>
                    </a>
                    {% else %}
                    <span
                        class="bg-gray-100 text-gray-400 px-4 py-2 rounded-lg border border-gray-200 text-sm font-medium cursor-not-allowed flex items-center">
                        Siguiente
                        <span class="ml-1">‚Üí</span>
                    </span>
                    {% endif %}
                </div>
            </div>

            <!-- Selector de elementos por p√°gina -->
            <div class="mt-4 flex items-center justify-center">
                <div class="flex items-center space-x-2 text-sm text-gray-600">
                    <span>Mostrar:</span>
                    <select id="per-page-selector" onchange="changePerPage(this.value)"
                        class="bg-white border border-gray-300 rounded-lg px-3 py-1 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="10" {{ 'selected' if request.args.get('per_page', '10' )=='10' }}>10 por p√°gina
                        </option>
                        <option value="25" {{ 'selected' if request.args.get('per_page', '10' )=='25' }}>25 por p√°gina
                        </option>
                        <option value="50" {{ 'selected' if request.args.get('per_page', '10' )=='50' }}>50 por p√°gina
                        </option>
                        <option value="100" {{ 'selected' if request.args.get('per_page', '10' )=='100' }}>100 por
                            p√°gina</option>
                    </select>
                </div>
            </div>
        </div>
        {% endif %}
    </div> {% else %}
    <!-- Estado vac√≠o mejorado -->
    <div class="bg-white rounded-2xl shadow-lg p-12 text-center">
        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <span class="text-gray-400 text-4xl">üìä</span>
        </div>
        <h3 class="text-2xl font-bold text-gray-900 mb-4">No hay reportes guardados</h3>
        <p class="text-gray-600 mb-8 text-lg max-w-md mx-auto">
            Comienza creando tu primer reporte mensual para ver estad√≠sticas detalladas de tus ingresos
        </p>
        <div class="space-y-4">
            <a href="{{ url_for('new_report') }}"
                class="inline-flex items-center bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl">
                <span class="mr-3 text-xl">üìù</span>
                Crear Primer Reporte
            </a>
            <div class="text-sm text-gray-500 mt-4">
                <p class="flex items-center justify-center">
                    <span class="mr-2">üí°</span>
                    Tip: Registra tus ingresos diarios para generar reportes autom√°ticamente
                </p>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Acciones r√°pidas -->
    <div class="bg-white rounded-2xl shadow-lg p-8">
        <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
            <span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">‚ö°</span>
            Acciones R√°pidas
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <a href="{{ url_for('dashboard') }}"
                class="group bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center justify-center">
                <span class="mr-3 text-xl">üè†</span>
                Volver al Dashboard
            </a>
            <a href="{{ url_for('new_report') }}"
                class="group bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center justify-center">
                <span class="mr-3 text-xl">‚ûï</span>
                Nuevo Reporte
            </a>
        </div>
    </div>
</div>

<script>
    function changePerPage(perPage) {
        const url = new URL(window.location);
        url.searchParams.set('per_page', perPage);
        url.searchParams.set('page', 1); // Reset to first page
        window.location.href = url.toString();
    }    // Sistema de actualizaci√≥n autom√°tica para formularios
    async function refreshContent() {
        try {
            const response = await fetch(window.location.href);
            if (response.ok) {
                const html = await response.text();
                const parser = new DOMParser();
                const newDocument = parser.parseFromHTML(html, 'text/html');

                // Detectar si es la primera entrada (estado vac√≠o)
                const currentTableRows = document.querySelectorAll('table tbody tr').length;
                const hasEmptyState = document.querySelector('.text-center.py-12, .text-gray-400, .text-2xl.font-bold.text-gray-900');

                // Si no hay datos previos o estado vac√≠o, recargar p√°gina completa
                if (currentTableRows === 0 || hasEmptyState) {
                    console.log('Primer reporte detectado - Recarga completa necesaria');
                    window.location.reload();
                    return;
                }

                // Estrategia de actualizaci√≥n completa para contenido din√°mico
                const mainContent = document.querySelector('.space-y-8');
                const newMainContent = newDocument.querySelector('.space-y-8');

                if (mainContent && newMainContent) {
                    // Guardar posici√≥n del scroll
                    const scrollY = window.scrollY;

                    // Actualizar todo el contenido principal
                    mainContent.innerHTML = newMainContent.innerHTML;

                    // Restaurar scroll
                    window.scrollTo(0, scrollY);

                    // Re-configurar eventos si es necesario
                    setTimeout(() => {
                        setupEventListeners();
                    }, 100);
                } else {
                    // Fallback: actualizar secciones espec√≠ficas
                    updateSpecificElements(newDocument);
                }
            }
        } catch (error) {
            console.log('Error al actualizar contenido:', error);
            // En caso de error, recargar p√°gina
            window.location.reload();
        }
    }

    // Funci√≥n de respaldo para actualizar elementos espec√≠ficos
    function updateSpecificElements(newDocument) {
        // Actualizar tabla de reportes si existe
        const currentTable = document.querySelector('table');
        const newTable = newDocument.querySelector('table');
        if (currentTable && newTable) {
            currentTable.parentNode.replaceChild(newTable, currentTable);
        }

        // Actualizar estad√≠sticas
        const currentStats = document.querySelectorAll('.text-3xl.font-bold');
        const newStats = newDocument.querySelectorAll('.text-3xl.font-bold');
        currentStats.forEach((stat, index) => {
            if (newStats[index]) {
                stat.textContent = newStats[index].textContent;
            }
        });

        // Actualizar cards de m√©tricas
        const currentCards = document.querySelectorAll('.bg-white.rounded-2xl');
        const newCards = newDocument.querySelectorAll('.bg-white.rounded-2xl');
        currentCards.forEach((card, index) => {
            if (newCards[index]) {
                const currentContent = card.querySelector('.text-3xl.font-bold, .text-lg.font-bold');
                const newContent = newCards[index].querySelector('.text-3xl.font-bold, .text-lg.font-bold');
                if (currentContent && newContent) {
                    currentContent.textContent = newContent.textContent;
                }
            }
        });
    }    // Configurar listeners de eventos para compatibilidad
    function setupEventListeners() {
        // Re-configurar cualquier evento que se haya perdido
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            if (!form.hasAttribute('data-configured')) {
                form.setAttribute('data-configured', 'true');
                setupFormListener(form);
            }
        });
    }

    // Configurar listener individual para formulario (mejorado)
    function setupFormListener(form) {
        form.addEventListener('submit', async function (e) {
            if (this.action && (this.action.includes('/add') || this.action.includes('/update') || this.action.includes('/save'))) {
                e.preventDefault();

                const formData = new FormData(this);
                const submitButton = this.querySelector('button[type="submit"], input[type="submit"]');
                const originalText = submitButton ? submitButton.innerHTML || submitButton.value : '';

                // Detectar si es primera entrada ANTES del env√≠o  
                const isFirstEntry = checkIfFirstEntryOfDay(this);
                console.log('üìã Primera entrada detectada en formulario individual:', isFirstEntry);

                // Mostrar estado de carga
                if (submitButton) {
                    submitButton.disabled = true;
                    if (submitButton.innerHTML !== undefined) {
                        submitButton.innerHTML = '<span class="flex items-center justify-center">‚è≥ Procesando...</span>';
                    } else {
                        submitButton.value = 'Procesando...';
                    }
                }

                try {
                    const response = await fetch(this.action, {
                        method: this.method || 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        showNotification('‚úÖ Cambios guardados exitosamente', 'success');

                        // Limpiar formulario si es de agregar
                        if (this.action.includes('/add')) {
                            this.reset();
                        }

                        if (isFirstEntry) {
                            console.log('üîÑ Primera entrada del d√≠a confirmada (individual) - Forzando recarga');
                            showNotification('üîÑ Primera entrada del d√≠a - Actualizando vista...', 'info');

                            setTimeout(() => {
                                console.log('üîÑ Ejecutando recarga para primera entrada (individual)...');
                                window.location.reload();
                            }, 1000);

                            // Restaurar bot√≥n
                            if (submitButton) {
                                setTimeout(() => {
                                    submitButton.disabled = false;
                                    if (submitButton.innerHTML !== undefined) {
                                        submitButton.innerHTML = originalText;
                                    } else {
                                        submitButton.value = originalText;
                                    }
                                }, 800);
                            }
                        } else {
                            console.log('‚ö° Entrada adicional (individual) - Actualizaci√≥n AJAX');
                            // Actualizar contenido inmediatamente para entradas subsecuentes
                            setTimeout(async () => {
                                await refreshReportContent();

                                // Restaurar bot√≥n
                                if (submitButton) {
                                    submitButton.disabled = false;
                                    if (submitButton.innerHTML !== undefined) {
                                        submitButton.innerHTML = originalText;
                                    } else {
                                        submitButton.value = originalText;
                                    }
                                }
                            }, 300);
                        }

                        // Verificaci√≥n adicional
                        scheduleReportPostSubmitVerification();

                    } else {
                        throw new Error('Error en el servidor');
                    }
                } catch (error) {
                    showNotification('‚ùå Error al procesar la solicitud', 'error');

                    // Restaurar bot√≥n en caso de error
                    if (submitButton) {
                        submitButton.disabled = false;
                        if (submitButton.innerHTML !== undefined) {
                            submitButton.innerHTML = originalText;
                        } else {
                            submitButton.value = originalText;
                        }
                    }
                }
            }
        });
    }// Detectar si hay formularios que necesitan actualizaci√≥n autom√°tica
    document.addEventListener('DOMContentLoaded', function () {
        // Configurar todos los eventos espec√≠ficos para reportes
        setupReportEvents();
    });

    // Delegar eventos para formularios din√°micos (funciona mejor para contenido nuevo)
    document.addEventListener('submit', async function (e) {
        const form = e.target;
        if (form.tagName === 'FORM' && form.action && (form.action.includes('/add') || form.action.includes('/update') || form.action.includes('/save'))) {
            e.preventDefault();

            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"], input[type="submit"]');
            const originalText = submitButton ? submitButton.innerHTML || submitButton.value : '';

            // Detectar si es primera entrada ANTES del env√≠o
            const isFirstEntry = checkIfFirstEntryOfDay(form);
            console.log('üîç DETECCI√ìN GLOBAL: Primera entrada del d√≠a:', isFirstEntry);

            // Mostrar estado de carga
            if (submitButton) {
                submitButton.disabled = true;
                if (submitButton.innerHTML !== undefined) {
                    submitButton.innerHTML = '<span class="flex items-center justify-center">‚è≥ Procesando...</span>';
                } else {
                    submitButton.value = 'Procesando...';
                }
            }

            try {
                const response = await fetch(form.action, {
                    method: form.method || 'POST',
                    body: formData
                });

                if (response.ok) {
                    showNotification('‚úÖ Cambios guardados exitosamente', 'success');

                    // Limpiar formulario si es de agregar
                    if (form.action.includes('/add')) {
                        form.reset();
                    }

                    if (isFirstEntry) {
                        console.log('üîÑ Primera entrada del d√≠a detectada - Recarga inmediata');
                        showNotification('üîÑ Primera entrada del d√≠a - Actualizando vista...', 'info');

                        setTimeout(() => {
                            console.log('üîÑ Ejecutando recarga para primera entrada...');
                            window.location.reload();
                        }, 1000);

                        // Restaurar bot√≥n
                        if (submitButton) {
                            setTimeout(() => {
                                submitButton.disabled = false;
                                if (submitButton.innerHTML !== undefined) {
                                    submitButton.innerHTML = originalText;
                                } else {
                                    submitButton.value = originalText;
                                }
                            }, 800);
                        }
                    } else {
                        console.log('‚ö° Entrada adicional - Actualizaci√≥n AJAX');
                        // Actualizar contenido inmediatamente para entradas subsecuentes
                        setTimeout(async () => {
                            await refreshReportContent();

                            // Restaurar bot√≥n
                            if (submitButton) {
                                submitButton.disabled = false;
                                if (submitButton.innerHTML !== undefined) {
                                    submitButton.innerHTML = originalText;
                                } else {
                                    submitButton.value = originalText;
                                }
                            }
                        }, 300);
                    }

                    // Verificaci√≥n adicional
                    scheduleReportPostSubmitVerification();

                } else {
                    throw new Error('Error en el servidor');
                }
            } catch (error) {
                showNotification('‚ùå Error al procesar la solicitud', 'error');

                // Restaurar bot√≥n en caso de error
                if (submitButton) {
                    submitButton.disabled = false;
                    if (submitButton.innerHTML !== undefined) {
                        submitButton.innerHTML = originalText;
                    } else {
                        submitButton.value = originalText;
                    }
                }
            }
        }
    });

    // Buscar formularios en la p√°gina
    const forms = document.querySelectorAll('form');

    forms.forEach(form => {
        form.addEventListener('submit', async function (e) {
            // Si es un formulario de agregar transacci√≥n
            if (this.action && (this.action.includes('/add') || this.action.includes('/update'))) {
                e.preventDefault();

                const formData = new FormData(this);

                try {
                    const response = await fetch(this.action, {
                        method: this.method || 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        // Mostrar notificaci√≥n de √©xito
                        showNotification('‚úÖ Cambios guardados exitosamente', 'success');

                        // Limpiar formulario si es necesario
                        if (this.action.includes('/add')) {
                            this.reset();
                        }

                        // Actualizar contenido autom√°ticamente
                        setTimeout(refreshContent, 500);

                    } else {
                        showNotification('‚ùå Error al guardar cambios', 'error');
                    }
                } catch (error) {
                    showNotification('‚ùå Error de conexi√≥n', 'error');
                }
            }
        });
    });

    // Sistema de notificaciones
    function showNotification(message, type = 'info') {
        // Remover notificaci√≥n existente
        const existing = document.getElementById('notification');
        if (existing) existing.remove();

        // Crear nueva notificaci√≥n
        const notification = document.createElement('div');
        notification.id = 'notification';
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-0 ${type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;

        notification.innerHTML = `
            <div class="flex items-center">
                <span class="text-sm font-medium">${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        `;

        document.body.appendChild(notification);

        // Auto-remover despu√©s de 3 segundos
        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 3000);
    }

    // Sistema espec√≠fico para creaci√≥n de reportes - Detectar primera entrada del d√≠a
    function checkIfFirstEntryOfDay(dayElement) {
        console.log('üîç Verificando si es primera entrada del d√≠a...');

        // Buscar el contenedor del d√≠a espec√≠fico
        const dayCard = dayElement ? dayElement.closest('.bg-white.rounded-2xl, .bg-white.rounded-xl, .border.border-gray-200') : null;

        if (dayCard) {
            // Verificar si el d√≠a tiene datos previos
            const hasExistingData = dayCard.querySelector('table tbody tr, .transaction-item, [class*="total"], [class*="amount"]');
            const hasMoneySymbol = dayCard.textContent.includes('$');
            const dayTotal = dayCard.querySelector('.text-green-600, .font-bold');

            console.log('üìä D√≠a tiene datos existentes:', !!hasExistingData);
            console.log('üìä D√≠a tiene s√≠mbolo $:', hasMoneySymbol);
            console.log('üìä D√≠a tiene total:', !!dayTotal);

            if (!hasExistingData || !hasMoneySymbol || !dayTotal) {
                console.log('‚úÖ Primera entrada del d√≠a detectada');
                return true;
            }
        }

        // Verificaci√≥n global si no hay elemento espec√≠fico
        const allDayCards = document.querySelectorAll('.bg-white.rounded-2xl, .bg-white.rounded-xl');
        const cardsWithData = Array.from(allDayCards).filter(card => {
            return card.textContent.includes('$') || card.querySelector('table tbody tr');
        });

        console.log('üìä Total cards de d√≠as:', allDayCards.length);
        console.log('üìä Cards con datos:', cardsWithData.length);

        if (cardsWithData.length === 0) {
            console.log('‚úÖ Primera entrada del reporte detectada');
            return true;
        }

        console.log('‚ùå No es primera entrada - hay datos previos');
        return false;
    }

    // Funci√≥n de actualizaci√≥n espec√≠fica para p√°gina de reporte
    async function refreshReportContent() {
        try {
            console.log('üîÑ Iniciando actualizaci√≥n de contenido del reporte...');

            const response = await fetch(window.location.href);
            if (response.ok) {
                const html = await response.text();
                const parser = new DOMParser();
                const newDocument = parser.parseFromHTML(html, 'text/html');

                // Detectar si era primera entrada ANTES de actualizar
                const wasFirstEntry = checkIfFirstEntryOfDay();
                console.log('üìä Era primera entrada antes:', wasFirstEntry);

                // Verificar si el nuevo contenido tiene m√°s datos
                const newDayCards = newDocument.querySelectorAll('.bg-white.rounded-2xl, .bg-white.rounded-xl');
                const newCardsWithData = Array.from(newDayCards).filter(card => {
                    return card.textContent.includes('$') || card.querySelector('table tbody tr');
                });

                console.log('üìä Nuevas cards con datos:', newCardsWithData.length);

                // Si era primera entrada PERO ahora hay datos, recargar p√°gina
                if (wasFirstEntry && newCardsWithData.length > 0) {
                    console.log('üîÑ DETECCI√ìN CR√çTICA: Primera entrada del d√≠a - Forzando recarga');
                    window.location.reload();
                    return;
                }

                // Actualizar contenido principal completo
                const currentMainContent = document.querySelector('.space-y-8');
                const newMainContent = newDocument.querySelector('.space-y-8');

                if (currentMainContent && newMainContent) {
                    console.log('‚ö° Actualizando contenido v√≠a AJAX');
                    // Guardar estado actual
                    const scrollPosition = window.scrollY;

                    // Actualizar todo el contenido
                    currentMainContent.innerHTML = newMainContent.innerHTML;

                    // Restaurar estado
                    window.scrollTo(0, scrollPosition);

                    // Re-configurar eventos
                    setTimeout(() => {
                        setupReportEvents();
                    }, 100);
                } else {
                    console.log('‚ö†Ô∏è No se pudo encontrar contenido principal - Fallback');
                    updateSpecificReportElements(newDocument);
                }
            }
        } catch (error) {
            console.log('‚ùå Error al actualizar contenido del reporte:', error);
            console.log('üîÑ Error detectado - Fallback a recarga completa');
            window.location.reload();
        }
    }

    // Funci√≥n para actualizar elementos espec√≠ficos del reporte
    function updateSpecificReportElements(newDocument) {
        console.log('üîÑ Ejecutando actualizaci√≥n espec√≠fica de elementos del reporte...');

        // Actualizar cards de d√≠as
        const currentDayCards = document.querySelectorAll('.bg-white.rounded-2xl, .bg-white.rounded-xl');
        const newDayCards = newDocument.querySelectorAll('.bg-white.rounded-2xl, .bg-white.rounded-xl');

        console.log('üîÑ Cards actuales:', currentDayCards.length, 'Cards nuevas:', newDayCards.length);

        // Si hay diferencia, recargar p√°gina completa
        if (newDayCards.length > currentDayCards.length) {
            console.log('üîÑ Detectadas nuevas cards de d√≠as - Recargando p√°gina');
            window.location.reload();
            return;
        }

        // Actualizar contenido de cards existentes
        currentDayCards.forEach((currentCard, index) => {
            if (newDayCards[index]) {
                const currentTotal = currentCard.querySelector('.text-green-600, .font-bold');
                const newTotal = newDayCards[index].querySelector('.text-green-600, .font-bold');

                if (currentTotal && newTotal && currentTotal.textContent !== newTotal.textContent) {
                    console.log('üîÑ Actualizando total del d√≠a', index);
                    currentTotal.textContent = newTotal.textContent;
                }

                // Actualizar tabla si existe
                const currentTable = currentCard.querySelector('table tbody');
                const newTable = newDayCards[index].querySelector('table tbody');

                if (currentTable && newTable) {
                    console.log('üîÑ Actualizando tabla del d√≠a', index);
                    currentTable.innerHTML = newTable.innerHTML;
                }
            }
        });
    }

    // Verificaci√≥n post-env√≠o para reportes
    function scheduleReportPostSubmitVerification() {
        setTimeout(() => {
            console.log('üîç Verificaci√≥n post-env√≠o del reporte...');

            const stillFirstEntry = checkIfFirstEntryOfDay();
            const hasDaysWithData = document.querySelectorAll('.bg-white.rounded-2xl, .bg-white.rounded-xl').length > 0;
            const hasContentWithMoney = document.body.textContent.includes('$');

            console.log('üîç Verificaci√≥n: A√∫n primera entrada:', stillFirstEntry);
            console.log('üîç Verificaci√≥n: Tiene d√≠as con datos:', hasDaysWithData);
            console.log('üîç Verificaci√≥n: Tiene contenido con $:', hasContentWithMoney);

            if (stillFirstEntry || !hasContentWithMoney) {
                console.log('‚ö†Ô∏è ALERTA: La entrada del d√≠a no apareci√≥');
                console.log('üîÑ Forzando recarga de seguridad...');
                showNotification('üîÑ Sincronizando entrada del d√≠a...', 'info');
                window.location.reload();
            } else {
                console.log('‚úÖ Verificaci√≥n exitosa: La entrada est√° visible en el reporte');
            }
        }, 2500);
    }

    // Configurar eventos espec√≠ficos para reportes
    function setupReportEvents() {
        const forms = document.querySelectorAll('form');

        forms.forEach(form => {
            if (!form.hasAttribute('data-report-configured')) {
                form.setAttribute('data-report-configured', 'true');

                form.addEventListener('submit', async function (e) {
                    if (this.action && (this.action.includes('/add') || this.action.includes('/update') || this.action.includes('/save'))) {
                        e.preventDefault();

                        const formData = new FormData(this);
                        const submitButton = this.querySelector('button[type="submit"], input[type="submit"]');
                        const originalText = submitButton ? submitButton.innerHTML || submitButton.value : '';

                        // Detectar si es primera entrada ANTES del env√≠o
                        const isFirstEntry = checkIfFirstEntryOfDay(this);
                        console.log('üìã Resultado detecci√≥n primera entrada:', isFirstEntry);

                        // Mostrar estado de carga
                        if (submitButton) {
                            submitButton.disabled = true;
                            if (submitButton.innerHTML !== undefined) {
                                submitButton.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Guardando...</span>';
                            } else {
                                submitButton.value = 'Guardando...';
                            }
                        }

                        try {
                            const response = await fetch(this.action, {
                                method: this.method || 'POST',
                                body: formData
                            });

                            if (response.ok) {
                                showNotification('‚úÖ Entrada guardada exitosamente', 'success');

                                // Limpiar formulario si es de agregar
                                if (this.action.includes('/add')) {
                                    this.reset();
                                }

                                if (isFirstEntry) {
                                    console.log('üîÑ Primera entrada del d√≠a confirmada - Forzando recarga');
                                    showNotification('üîÑ Primera entrada del d√≠a - Actualizando vista...', 'info');

                                    setTimeout(() => {
                                        console.log('üîÑ Ejecutando recarga para primera entrada...');
                                        window.location.reload();
                                    }, 1000);

                                    // Restaurar bot√≥n despu√©s de un momento
                                    if (submitButton) {
                                        setTimeout(() => {
                                            submitButton.disabled = false;
                                            if (submitButton.innerHTML !== undefined) {
                                                submitButton.innerHTML = originalText;
                                            } else {
                                                submitButton.value = originalText;
                                            }
                                        }, 800);
                                    }
                                } else {
                                    console.log('‚ö° Entrada adicional - Actualizaci√≥n AJAX');
                                    setTimeout(async () => {
                                        await refreshReportContent();

                                        // Restaurar bot√≥n
                                        if (submitButton) {
                                            submitButton.disabled = false;
                                            if (submitButton.innerHTML !== undefined) {
                                                submitButton.innerHTML = originalText;
                                            } else {
                                                submitButton.value = originalText;
                                            }
                                        }
                                    }, 300);
                                }

                                // Verificaci√≥n adicional
                                scheduleReportPostSubmitVerification();

                            } else {
                                throw new Error('Error en el servidor');
                            }
                        } catch (error) {
                            showNotification('‚ùå Error al guardar la entrada', 'error');

                            // Restaurar bot√≥n en caso de error
                            if (submitButton) {
                                submitButton.disabled = false;
                                if (submitButton.innerHTML !== undefined) {
                                    submitButton.innerHTML = originalText;
                                } else {
                                    submitButton.value = originalText;
                                }
                            }
                        }
                    }
                });
            }
        });
    }

    // ...existing code...
</script>

{% endblock %}