<!-- Sistema de actualizaci√≥n autom√°tica espec√≠fico para creaci√≥n de reportes -->
<script>
    // Funci√≥n espec√≠fica para detectar primera entrada en nuevo reporte
    function detectFirstEntryInNewReport(formElement) {
        console.log('üîç Detectando primera entrada en nuevo reporte...');

        // Buscar el contenedor del d√≠a espec√≠fico del formulario
        const dayContainer = formElement ? formElement.closest('.day-container, .bg-white.rounded-2xl, .bg-white.rounded-xl, .border') : null;

        if (dayContainer) {
            // Verificar si este d√≠a espec√≠fico tiene entradas previas
            const existingEntries = dayContainer.querySelector('table tbody tr, .transaction-list, .entry-item');
            const hasMoneyDisplay = dayContainer.textContent.includes('$');
            const hasTotalAmount = dayContainer.querySelector('.total-amount, .day-total, .text-green-600');

            console.log('üìä D√≠a tiene entradas previas:', !!existingEntries);
            console.log('üìä D√≠a muestra dinero:', hasMoneyDisplay);
            console.log('üìä D√≠a tiene total:', !!hasTotalAmount);

            // Si no hay entradas, dinero o total en este d√≠a espec√≠fico = primera entrada
            if (!existingEntries || !hasMoneyDisplay || !hasTotalAmount) {
                console.log('‚úÖ Primera entrada del d√≠a detectada en nuevo reporte');
                return true;
            }
        }

        // Verificaci√≥n global para el reporte completo
        const allDayContainers = document.querySelectorAll('.day-container, .bg-white.rounded-2xl, .bg-white.rounded-xl');
        const containersWithData = Array.from(allDayContainers).filter(container => {
            return container.textContent.includes('$') ||
                container.querySelector('table tbody tr, .transaction-list, .entry-item') ||
                container.querySelector('.total-amount, .day-total');
        });

        console.log('üìä Total contenedores de d√≠as:', allDayContainers.length);
        console.log('üìä Contenedores con datos:', containersWithData.length);

        // Si no hay contenedores con datos = primer reporte completamente vac√≠o
        if (containersWithData.length === 0) {
            console.log('‚úÖ Primera entrada del reporte completo detectada');
            return true;
        }

        console.log('‚ùå No es primera entrada - hay datos previos en el reporte');
        return false;
    }

    // Sistema de actualizaci√≥n para creaci√≥n de reportes
    async function updateNewReportContent() {
        try {
            console.log('üîÑ Actualizando contenido del nuevo reporte...');

            const response = await fetch(window.location.href);
            if (response.ok) {
                const html = await response.text();
                const parser = new DOMParser();
                const newDocument = parser.parseFromHTML(html, 'text/html');

                // Detectar si era primera entrada ANTES de actualizar
                const wasFirstEntry = detectFirstEntryInNewReport();
                console.log('üìä Era primera entrada antes:', wasFirstEntry);

                // Verificar contenido nuevo
                const newDayContainers = newDocument.querySelectorAll('.day-container, .bg-white.rounded-2xl, .bg-white.rounded-xl');
                const newContainersWithData = Array.from(newDayContainers).filter(container => {
                    return container.textContent.includes('$') || container.querySelector('table tbody tr');
                });

                console.log('üìä Nuevos contenedores con datos:', newContainersWithData.length);

                // Si era primera entrada PERO ahora hay datos = recargar p√°gina
                if (wasFirstEntry && newContainersWithData.length > 0) {
                    console.log('üîÑ DETECCI√ìN CR√çTICA: Primera entrada en nuevo reporte - Forzando recarga');
                    window.location.reload();
                    return;
                }

                // Actualizaci√≥n AJAX para entradas subsecuentes
                const currentMainContent = document.querySelector('.container, .max-w-7xl, .space-y-8, main');
                const newMainContent = newDocument.querySelector('.container, .max-w-7xl, .space-y-8, main');

                if (currentMainContent && newMainContent) {
                    console.log('‚ö° Actualizando contenido v√≠a AJAX en nuevo reporte');

                    // Guardar estado
                    const scrollPosition = window.scrollY;

                    // Actualizar contenido
                    currentMainContent.innerHTML = newMainContent.innerHTML;

                    // Restaurar estado
                    window.scrollTo(0, scrollPosition);

                    // Re-configurar eventos
                    setTimeout(() => {
                        setupNewReportEvents();
                    }, 100);
                } else {
                    console.log('‚ö†Ô∏è Fallback: Actualizaci√≥n espec√≠fica de elementos');
                    updateSpecificNewReportElements(newDocument);
                }
            }
        } catch (error) {
            console.log('‚ùå Error al actualizar nuevo reporte:', error);
            window.location.reload();
        }
    }

    // Actualizar elementos espec√≠ficos del nuevo reporte
    function updateSpecificNewReportElements(newDocument) {
        console.log('üîÑ Actualizando elementos espec√≠ficos del nuevo reporte...');

        // Actualizar contenedores de d√≠as
        const currentDayContainers = document.querySelectorAll('.day-container, .bg-white.rounded-2xl, .bg-white.rounded-xl');
        const newDayContainers = newDocument.querySelectorAll('.day-container, .bg-white.rounded-2xl, .bg-white.rounded-xl');

        // Si hay diferencia en n√∫mero = recargar
        if (newDayContainers.length !== currentDayContainers.length) {
            console.log('üîÑ Cambio en estructura de d√≠as - Recargando');
            window.location.reload();
            return;
        }

        // Actualizar contenido de cada d√≠a
        currentDayContainers.forEach((currentContainer, index) => {
            if (newDayContainers[index]) {
                // Actualizar totales del d√≠a
                const currentTotal = currentContainer.querySelector('.total-amount, .day-total, .text-green-600, .font-bold');
                const newTotal = newDayContainers[index].querySelector('.total-amount, .day-total, .text-green-600, .font-bold');

                if (currentTotal && newTotal && currentTotal.textContent !== newTotal.textContent) {
                    console.log('üîÑ Actualizando total del d√≠a', index);
                    currentTotal.textContent = newTotal.textContent;
                }

                // Actualizar listas de entradas
                const currentEntries = currentContainer.querySelector('table tbody, .transaction-list, .entries-list');
                const newEntries = newDayContainers[index].querySelector('table tbody, .transaction-list, .entries-list');

                if (currentEntries && newEntries) {
                    console.log('üîÑ Actualizando entradas del d√≠a', index);
                    currentEntries.innerHTML = newEntries.innerHTML;
                }
            }
        });
    }

    // Configurar eventos para formularios de nuevo reporte
    function setupNewReportEvents() {
        console.log('üîß Configurando eventos para nuevo reporte...');

        const forms = document.querySelectorAll('form');

        forms.forEach(form => {
            if (!form.hasAttribute('data-new-report-configured')) {
                form.setAttribute('data-new-report-configured', 'true');

                form.addEventListener('submit', async function (e) {
                    if (this.action && (this.action.includes('/add') || this.action.includes('/save') || this.action.includes('/update'))) {
                        e.preventDefault();

                        const formData = new FormData(this);
                        const submitButton = this.querySelector('button[type="submit"], input[type="submit"]');
                        const originalText = submitButton ? (submitButton.innerHTML || submitButton.value) : '';

                        // Detectar primera entrada ANTES del env√≠o
                        const isFirstEntry = detectFirstEntryInNewReport(this);
                        console.log('üìã Primera entrada detectada en nuevo reporte:', isFirstEntry);

                        // Estado de carga
                        if (submitButton) {
                            submitButton.disabled = true;
                            if (submitButton.innerHTML !== undefined) {
                                submitButton.innerHTML = '<span class="flex items-center justify-center">‚è≥ Guardando...</span>';
                            } else {
                                submitButton.value = 'Guardando...';
                            }
                        }

                        try {
                            const response = await fetch(this.action, {
                                method: this.method || 'POST',
                                body: formData
                            });

                            if (response.ok) {
                                showNotification('‚úÖ Entrada guardada exitosamente', 'success');

                                // Limpiar formulario si es de agregar
                                if (this.action.includes('/add')) {
                                    this.reset();
                                }

                                if (isFirstEntry) {
                                    console.log('üîÑ Primera entrada del d√≠a en nuevo reporte - Forzando recarga');
                                    showNotification('üîÑ Primera entrada del d√≠a - Actualizando vista...', 'info');

                                    setTimeout(() => {
                                        console.log('üîÑ Ejecutando recarga para primera entrada...');
                                        window.location.reload();
                                    }, 1000);

                                    // Restaurar bot√≥n
                                    if (submitButton) {
                                        setTimeout(() => {
                                            submitButton.disabled = false;
                                            if (submitButton.innerHTML !== undefined) {
                                                submitButton.innerHTML = originalText;
                                            } else {
                                                submitButton.value = originalText;
                                            }
                                        }, 800);
                                    }
                                } else {
                                    console.log('‚ö° Entrada adicional en nuevo reporte - Actualizaci√≥n AJAX');
                                    setTimeout(async () => {
                                        await updateNewReportContent();

                                        // Restaurar bot√≥n
                                        if (submitButton) {
                                            submitButton.disabled = false;
                                            if (submitButton.innerHTML !== undefined) {
                                                submitButton.innerHTML = originalText;
                                            } else {
                                                submitButton.value = originalText;
                                            }
                                        }
                                    }, 300);
                                }

                                // Verificaci√≥n post-env√≠o
                                setTimeout(() => {
                                    const stillFirstEntry = detectFirstEntryInNewReport();
                                    if (stillFirstEntry) {
                                        console.log('‚ö†Ô∏è ALERTA: Entrada no apareci√≥ en nuevo reporte - Recargando');
                                        window.location.reload();
                                    }
                                }, 2500);

                            } else {
                                throw new Error('Error en servidor');
                            }
                        } catch (error) {
                            showNotification('‚ùå Error al guardar entrada', 'error');

                            // Restaurar bot√≥n
                            if (submitButton) {
                                submitButton.disabled = false;
                                if (submitButton.innerHTML !== undefined) {
                                    submitButton.innerHTML = originalText;
                                } else {
                                    submitButton.value = originalText;
                                }
                            }
                        }
                    }
                });
            }
        });
    }

    // Inicializar sistema para nuevo reporte
    document.addEventListener('DOMContentLoaded', function () {
        setupNewReportEvents();

        // Tambi√©n configurar delegaci√≥n de eventos global
        document.addEventListener('submit', async function (e) {
            const form = e.target;
            if (form.tagName === 'FORM' &&
                form.action &&
                (form.action.includes('/add') || form.action.includes('/save') || form.action.includes('/update')) &&
                !form.hasAttribute('data-new-report-configured')) {

                e.preventDefault();

                const formData = new FormData(form);
                const submitButton = form.querySelector('button[type="submit"], input[type="submit"]');
                const originalText = submitButton ? (submitButton.innerHTML || submitButton.value) : '';

                // Detectar primera entrada
                const isFirstEntry = detectFirstEntryInNewReport(form);
                console.log('üîç DETECCI√ìN GLOBAL NUEVO REPORTE: Primera entrada:', isFirstEntry);

                // Estado de carga
                if (submitButton) {
                    submitButton.disabled = true;
                    if (submitButton.innerHTML !== undefined) {
                        submitButton.innerHTML = '<span class="flex items-center justify-center">‚è≥ Procesando...</span>';
                    } else {
                        submitButton.value = 'Procesando...';
                    }
                }

                try {
                    const response = await fetch(form.action, {
                        method: form.method || 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        showNotification('‚úÖ Entrada guardada exitosamente', 'success');

                        if (form.action.includes('/add')) {
                            form.reset();
                        }

                        if (isFirstEntry) {
                            console.log('üîÑ Primera entrada detectada - Recarga inmediata');
                            showNotification('üîÑ Primera entrada del d√≠a - Actualizando vista...', 'info');

                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            console.log('‚ö° Entrada adicional - Actualizaci√≥n AJAX');
                            setTimeout(async () => {
                                await updateNewReportContent();
                            }, 300);
                        }

                        // Restaurar bot√≥n
                        setTimeout(() => {
                            if (submitButton) {
                                submitButton.disabled = false;
                                if (submitButton.innerHTML !== undefined) {
                                    submitButton.innerHTML = originalText;
                                } else {
                                    submitButton.value = originalText;
                                }
                            }
                        }, isFirstEntry ? 800 : 300);

                    } else {
                        throw new Error('Error en servidor');
                    }
                } catch (error) {
                    showNotification('‚ùå Error al procesar solicitud', 'error');

                    if (submitButton) {
                        submitButton.disabled = false;
                        if (submitButton.innerHTML !== undefined) {
                            submitButton.innerHTML = originalText;
                        } else {
                            submitButton.value = originalText;
                        }
                    }
                }
            }
        });
    });

    // Sistema de notificaciones si no existe
    if (typeof showNotification !== 'function') {
        function showNotification(message, type = 'info') {
            const existing = document.getElementById('notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                        'bg-blue-500 text-white'
                }`;

            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="text-sm font-medium">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                        ‚úï
                    </button>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 3000);
        }
    }
</script>